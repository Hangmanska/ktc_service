
var moment = require('moment');
//var token ="ZlyfamuXdnyAhDuxBTMPq2SwlnpUcqKXlbIOesDY7IE"   //for iZero
//var token ="esWe0W4wDO7uzw8uihdjghoSP6hJdlfk8WEQhIKHV7w";  //for schoolbus_ktc
//var token ="9vpsjcY3nkHAdrldjYkEEOPjdTpMwEkf1ITZR575Nte"  //for scg_notification   : SCG Speed Alert
var exec = require('child_process').exec;
var hpt = require('hp_timer.js');
var request = require('request');

//https://notify-bot.line.me/th/

function prepare_msg()
{
  var student_name ="ดนัย ใจประเสริจ";
  var loc ="ลาดพร้าว:ลาดพร้าว:กรุงเทพมหานคร";
  var up_down ="ขึ้น"

  var msg = '\n'+"วันที่ : "+moment().format("DD-MM-YYYY")+'\n'
      msg +="เวลา : "+moment().format("HH:mm:ss")+'\n'
      msg +="ชื่อ : "+student_name+'\n'
      msg +="สถานะ : "+up_down+'\n' 
      msg +="สถานที่ : "+loc+" "

    //  var imgpath = __dirname+'\\digit.jpg';
     // send_line(msg,imgpath);
    //console.log(__dirname+'\\1.png')
    var imgpath ="/root/test_curl/digit.jpg";
    curl_send_line(token,msg,imgpath)

   // var imgpath = "http://61.91.14.253:8001/assets/img/icon/vehicle/v2_180.png";

}

function prepare_msg_vt900(ar,vehicle_name,modem_id,line_token,callback)
{
 // var name ="ดนัย ใจประเสริจ";
 // var loc ="ลาดพร้าว:ลาดพร้าว:กรุงเทพมหานคร";
 // var up_down ="ขึ้น"

 var msg = '\n'+"วันที่ : "+moment().format("DD-MM-YYYY")
      msg +=" เวลา : "+moment().format("HH:mm:ss")+'\n'
      msg +="ชื่อรถ : "+vehicle_name+'\n'
      msg +="เวลาเริ่มสตาร์ท : "+ar.time_start+' \n' 
      msg +="https://www.google.com/maps?q="+ar.latlon_start+'\n'
      msg +=ar.loc_start+'\n' 
      msg +="เวลาถึงปลายทาง : "+ar.time_stop+'\n' 
      msg +="https://www.google.com/maps?q="+ar.latlon_stop+'\n'
      msg +=ar.loc_stop+'\n' 

      msg +="น้ำมันเริ่มสตาร์ท : "+ar.fuel_start+' (ลิตร)\n'
      msg +="น้ำมันที่ใช้ไป : "+ar.fuel_used+' (ลิตร)\n' 
      msg +="น้ำมันคงเหลือ = "+ar.fuel_left+' (ลิตร)\n' 
      msg +="ระยะทางทั้งหมด = "+ar.distance+' (กิโลเมตร)\n' 


      msg +="เวลาจอดติดเครื่อง : "+hpt.min2hhmm(ar.min_idle)+' (hh:mm) \n' 
      msg +="เวลาจอดดับเครื่อง: "+ hpt.min2hhmm(ar.min_stop)+' (hh:mm) \n' 
      msg +="รวมเวลาวิ่งทั้งหมด : "+hpt.min2hhmm(ar.min_run)+' (hh:mm) '  

    //  var imgpath = __dirname+'\\digit.jpg';
     // send_line(msg,imgpath);
    //console.log(__dirname+'\\1.png')
    var imgpath ="/root/image_schoolbus/img_"+modem_id+".jpg";
    curl_send_line(line_token,msg,imgpath,function(res_line)
    {
      callback(res_line);
      return;
    })

   // var imgpath = "http://61.91.14.253:8001/assets/img/icon/vehicle/v2_180.png";

}


function curl_send_line(token,msg,imagepath,callback)
{
 // var msg = Buffer.from(msg, 'utf-8');
  //msg="Hello World"
 // msg= "'" + msg + "'"
   // -F 'imageFile=@/PATH/TO/IMAGE/cony.jpg'
  var command = "curl -X POST https://notify-api.line.me/api/notify -H 'Authorization: Bearer '"+token+" -F 'message='"+msg+" -F 'imageFile=@'"+imagepath+" ";
 //var command = 'curl -X POST https://notify-api.line.me/api/notify -H "Authorization: Bearer '+token+'" -F "message='+msg+'" ';
 
 //var command = "curl -X POST https://notify-api.line.me/api/notify -H 'Authorization: Bearer "+token+"' -F 'message="+msg+"' -F 'imageFile=@'"+imagepath+""
 //$ curl -X POST -H "Authorization: Bearer XXXXXXXXXXXX" -F "message=Hello World" https://notify-api.line.me/api/notify  
 
 child =exec(command, function (error,stdout,stderr) 
    {
        if(error !=null)
        {
            console.log(error);
        }
        callback(stdout);
        return;
       // console.log(stdout);
      
    });

}

exports.prepare_msg_vt900 =prepare_msg_vt900;

//prepare_msg();
//prepare_msg_vt900_test(function(x){});

//https://engineering.linecorp.com/ja/blog/detail/94
/*
curl -X POST https://notify-api.line.me/api/notify -H 'Authorization: Bearer ZlyfamuXdnyAhDuxBTMPq2SwlnpUcqKXlbIOesDY7IE' -F 'message=test' -F 'stickerPackageId=1' -F 'stickerId=113'

curl -X POST https://notify-api.line.me/api/notify -H 'Authorization: Bearer ZlyfamuXdnyAhDuxBTMPq2SwlnpUcqKXlbIOesDY7IE' -F 'message=test' -F 'imageFile=@/root/test_curl/digit.jpg'

   line_msg.prepare_msg_vt900_SCG(res_fuel[0],vehicle_name,modem_id,line_token,function(res_line)
        {
            callback(res_line);
            return;
        })

*/

function send_line(msg,token,callback)
{
    // var msg = "Test Noti ได้ป่าวว่ะ ";
  request({
     method: 'POST',
     uri: 'https://notify-api.line.me/api/notify',
     headers: {
       'Content-Type': 'application/x-www-form-urlencoded',
  },
     'auth': {
       'bearer': token
  },form: {
       message: msg,
    }
  }, (err,httpResponse,body) => {
    // console.log(JSON.stringify(err));
    // console.log(JSON.stringify(httpResponse));
    // console.log(JSON.stringify(body));
     callback(true);
     return;
  })
}

function LINE_SCG_overspeed(ar,callback)
{
  /*
  var vehicle_name ="2ฒษ6973_BSE";
  var speed_over="150";
  var speed_setting='120'
  var token ="9vpsjcY3nkHAdrldjYkEEOPjdTpMwEkf1ITZR575Nte"
  var lat ='7.98201';
  var lon ='98.371975';
  var latlon = lat+','+lon;

  var msg ="⚠️ แจ้งเตือน ⚠️ \r\n"
      msg += 'วันที่ : '+moment().format("DD-MM-YYYY")+' เวลา : '+moment().format("HH:mm:ss")+'\r\n'
      msg +='รถ : '+vehicle_name+'\r\n'
      msg +='ความเร็วเกิน : '+speed_over+' km/h (limit speed :'+speed_setting+' )\r\n' 
      msg +='https://www.google.com/maps?q='+latlon+'\r\n'
  */



  var msg ="⚠️ แจ้งเตือน ⚠️ \r\n"
      msg += 'วันที่ : '+moment(ar.gps_datetime).format("DD-MM-YYYY")+' เวลา : '+moment(ar.gps_datetime).format("HH:mm:ss")+'\r\n'
      msg +='รถ : '+ar.vehicle_name+'\r\n'
      msg +='ความเร็วเกิน : '+ar.speed_over+' km/h (limit speed :'+ar.speed_setting+' )\r\n' 
      msg +='https://www.google.com/maps?q='+ar.latlon+'\r\n'
      


      var imgpath = __dirname+'\\1.jpg';
     // send_line(msg,imgpath);
    //console.log(__dirname+'\\1.png')
    //var imgpath ="/root/image_schoolbus/1.jpg";
    // var imgpath = "http://61.91.14.253:8001/assets/img/icon/vehicle/v2_180.png";
    send_line(msg,ar.line_token,function(res_line)
   {
      callback(res_line);
     return;
   })

   

}


function LINE_KMP_Harverster_Parking(ar,callback)
{
  /*
  var vehicle_name ="2ฒษ6973_BSE";
  var speed_over="150";
  var speed_setting='120'
  var token ="9vpsjcY3nkHAdrldjYkEEOPjdTpMwEkf1ITZR575Nte"
  var lat ='7.98201';
  var lon ='98.371975';
  var latlon = lat+','+lon;

  var msg ="⚠️ แจ้งเตือน ⚠️ \r\n"
      msg += 'วันที่ : '+moment().format("DD-MM-YYYY")+' เวลา : '+moment().format("HH:mm:ss")+'\r\n'
      msg +='รถ : '+vehicle_name+'\r\n'
      msg +='ความเร็วเกิน : '+speed_over+' km/h (limit speed :'+speed_setting+' )\r\n' 
      msg +='https://www.google.com/maps?q='+latlon+'\r\n'
  */



  var msg ="⚠️ แจ้งเตือน ⚠️ \r\n"
      msg +='รถตัด : '+ar.vehicle_name+'\r\n'
      msg +='จอดตั้งแต่เวลา : '+ar.start_parking+'  (รวมเวลาที่จอด : '+ar.hour_min+' hh:mm )\r\n' 
      msg += 'วันเวลา GPS ล่าสุด : '+moment(ar.gps_datetime).format("DD-MM-YYYY HH:mm")+'\r\n'
      msg +='https://www.google.com/maps?q='+ar.latlon+'\r\n'
      


      var imgpath = __dirname+'\\1.jpg';
     // send_line(msg,imgpath);
    //console.log(__dirname+'\\1.png')
    //var imgpath ="/root/image_schoolbus/1.jpg";
    // var imgpath = "http://61.91.14.253:8001/assets/img/icon/vehicle/v2_180.png";
    send_line(msg,ar.line_token,function(res_line)
   {
      callback(res_line);
     return;
   })

   

}

exports.LINE_SCG_overspeed = LINE_SCG_overspeed;

exports.LINE_KMP_Harverster_Parking = LINE_KMP_Harverster_Parking;


/*
prepare_msg_vt900_scg_test(function(res)
{
  console.log(res);
});
*/