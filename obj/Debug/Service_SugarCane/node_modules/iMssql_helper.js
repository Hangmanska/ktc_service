
//#region 

var sql = require('mssql');

var config =
    {
    server: ' ',//'127.0.0.1',
    user: ' ',//'sa',
    password: ' ',//'1234',
    database: ' '//'Test_Split'
}

var ivar = {
    sp_name : " ",
    iname : " ",
    ivalue : " ",
    ar_name : [],
    ar_value: [],
    request : null
}

//#endregion

//#region setparam

function array_param()
{
    
   // var para_name = 'name,data';
   // var para_value = 'POS,g=74=1|b=68=2|y=64=2|b=75=2|b=73=2|b=66=2|r=77=2|y=71=3';
    //debugger
    ivar.name = ivar.iname.split(',');
    ivar.value = ivar.ivalue.split(',');

    for (var i = 0; i < ivar.name.length; i++)
    {
        var n = ivar.name[i];
        var v = ivar.value[i];
        ivar.request.input(n, v);
    }
}

function array_param2(name,value) {

    // var para_name = 'name,data';
    // var para_value = 'POS,g=74=1|b=68=2|y=64=2|b=75=2|b=73=2|b=66=2|r=77=2|y=71=3';
    //debugger
    ivar.name = name.split(',');
    ivar.value = value.split(',');

    for (var i = 0; i < ivar.name.length; i++) {
        var n = ivar.name[i];
        var v = ivar.value[i];
        ivar.request.input(n, v);
    }
}

    //#endregion

    /*
     var config =
 {
     server: 'mpk-caneol.mitrphol.com',//'127.0.0.1',
     user: 'htt-cl',//'sa',
     password: 'KoD3C93ZEj',//'1234',
     database: 'htt-cl-withdata'//'htt-cl'//'Test_Split'  
 }
     */

//#region set connection

function iconnect_db(config, callback) {
    // connect();
    //debugger;
    sql.connect(config, function (err) {
        // ... error checks
        if (err) {
            console.log(err);

        }
        // Query
        //SELECT DISTINCT [FCSKID],FCADDRESS FROM [TMS_KCG].[dbo].[TEMP_Customer]
        var request = new sql.Request();
        callback(request);
        return;
    });
}

function setcon(server,user,pws,db_name)
{
    config.server = server;
    config.user = user;
    config.password = pws;
    config.database = db_name;
}

function getcon(callback)
{
    
   // var request=null;
    var connection = new sql.Connection(config, function (err)
    {
        // ... error checks
      //  console.dir(err);
        // Query

        ivar.request = connection.request();
        // array_param();
        callback(true);
        return;
    });
   // return request;
}


function connect() {
    //setcon('mpk-caneol.mitrphol.com', 'htt-cl', 'KoD3C93ZEj', 'htt-cl-withdata');
    setcon('mpk-caneol.mitrphol.com', 'htt-cl', 'KoD3C93ZEj', 'htt-cl');
    //imssql.setcon('(local)', 'sa', 'pdaserver@58', 'WSEmb');
  // setcon('127.0.0.1', 'sa', '1234', 'TMS_Master');
}

function connect_db(server_name, user, password, db_name)
{
    setcon(server_name, user, password, db_name);
    //imssql.setcon('(local)', 'sa', 'pdaserver@58', 'WSEmb');
}

//#endregion


//+++++++ Don't Add @ prefix in parameter store
//#region excute get_row 


function nonquery(sp_name, name, value, callback) {
    connect();
    //debugger;
    ivar.iname = name;
    ivar.ivalue = value;
    ivar.sp_name = sp_name;

    getcon(function (res) {
        if (res) {
            array_param();
        //   debugger;
           ivar.request.execute(ivar.sp_name, function (err, recordsets, returnValue) {
               if (err) {
                 //  debugger;
                   console.log(err);
               }
                callback(recordsets);
                return;
            });
        }
    });
}


function nonquery2(config,sp_name, name, value, callback) {
    //connect();
    connect_db(config.server,config.user,config.password,config.database);
  //  debugger;
   // ivar.iname = name;
 //   ivar.ivalue = value;
    ivar.sp_name = sp_name;
  //  console.log(row);

    getcon(function (res) {
        if (res)
        {
            array_param2(name,value);
            //   debugger;
            // request.query
            ivar.request.execute(ivar.sp_name, function (err, recordsets, returnValue)// ivar.request.execute('split', function (err, recordsets, returnValue)
            {
                // 
                callback(recordsets);
                return;
                //console.log(row);
            });
        }
    });


}


function get_rows(config, sql, callback) {
    iconnect_db(config, function (request) {
        request.query(sql, function (err, recordset) {
            // ... error checks
            //  debugger;
            //console.log(recordset);
            callback(recordset);
            return;
        });
    });
}


function excute(config, sql, callback) {
    iconnect_db(config, function (request) {
        request.query(sql, function (err, recordset) {
            // ... error checks
            debugger;
            if (err) {
                callback(err);
                return;
            } else {
                //console.log(recordset);
                if (typeof recordset === 'undefined') {
                    callback('oK');
                    return;
                } 
            }
           
        });
    });
}


//#endregion

//#region exports
exports.get_rows = get_rows;
exports.excute = excute;
exports.iconnect_db = iconnect_db;

exports.nonquery2 = nonquery2;
exports.nonquery = nonquery;
exports.connect_db = connect_db;
exports.setcon = setcon;

//#endregion