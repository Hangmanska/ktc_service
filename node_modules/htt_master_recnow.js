
//#region
var async = require('async');
var squel = require("squel");
var timespan = require('timespan');
var mustache = require("mustache");
var moment = require('moment');


var utl = require('Utility.js');
var db = require('iConnectdb.js');
var utcp = require('Utility_tcp.js');
var linq = require('linq.js');

var inout = require('inout_polygon.js');
var iRep = require('iReport.js');
var out_of_service = require('out_of_service.js');
var hvt = require('harvester_in_out_farm.js');
var dtc2cane = require('dtc2cane.js');

var pg_htt = new db.im2(db.get_dbconfig_htt());
var htt_realtime = new db.im2(db.get_dbconfig_realtime());
var radius_track_and_havester = 15;
var inow = moment().format("YYYYMMDDHHmmssSSS");
var status_cutting = 11;
//#endregion

//#region harvester

function havester_operate(data, callback)
{
    debugger;
    var doprocess = false;

   // console.log(data);
    var result = { 'column': "htt_status_operation", 'key': data.blackbox_id, 'val': '','cane_status': ' ' }
    switch (data.r_io)
    {
        case 11: {
            if (data.htt_status_operation != 'CUTTING_LOADING')
            {
            
                var st1 = false; var st2 = false;
                var t = {'harvester_name':' ','truck_name':' ', 'is_inzone': false, 'name_farmer': ' ', 'zone_id': ' ', 'truck_blackbox_id': ' ', 'plot_code': ' ', 'r_time': ' ','qt':' ' };

                //inside farm's
                hvt.is_infarm(data.blackbox_id, data.lon, data.lat, function (result1)
                {
                    debugger;
                    if (result1.length > 0)
                    {
                        console.log('++++ havester_operate inside farm +++');
                        t.harvester_name = result1[0].harvester_name;
                        t.plot_code = result1[0].plot_code;
                        t.is_inzone = result1[0].is_inzone;
                        t.zone_id = result1[0].zone_id;
                        t.name_farmer = result1[0].name;
                        t.qt = result1[0].qt;
                    }
                    st1 = true;
                    fin();
                });

                hvt.has_harvester_truck(data.blackbox_id, data.lon, data.lat, radius_track_and_havester, function (result2)
                {
                    debugger;
                    if (result2.blackbox_id != 0) {
                        console.log('++++ truck_operate inside farm +++');
                        t.truck_blackbox_id = result2.blackbox_id;
                        t.r_time = result2.r_time;
                        t.truck_name = result2.name;
                    }
                    st2 = true;
                    fin();
                });

                function fin()
                {
                    if (st1 && st2)
                    {
                        console.log(' havester_operate ' + JSON.stringify(t));

                      //  t.truck_blackbox_id = '189600110834'
                        debugger;
                        if (t.truck_blackbox_id != ' ' && t.plot_code != ' ')
                        {
                            result.val = "CUTTING_LOADING";
                            result.cane_status = "CUTTING_AND_LOADING";
                            doprocess = true;

                            //set harvester
                            var sql_harvester = "UPDATE rec_now SET htt_qt=" + utl.sqote(t.qt) + ",htt_match_harvester_truck=" + utl.sqote(data.blackbox_id + ',' + t.truck_blackbox_id) + ",htt_plotcode=" + utl.sqote(t.zone_id) + ",htt_name_farmer=" + utl.sqote(t.name_farmer) + " WHERE blackbox_id=" + utl.sqote(data.blackbox_id);

                            //set truck
                            var sql_truck = "UPDATE rec_now SET htt_qt=" + utl.sqote(t.qt) + ",htt_transectionid=" + utl.sqote(inow) + ",htt_harvester_name=" + utl.sqote(t.harvester_name) + ",htt_truck_name=" + utl.sqote(t.truck_name) + ", htt_match_harvester_truck=" + utl.sqote(data.blackbox_id + ',' + t.truck_blackbox_id) + ",htt_plotcode=" + utl.sqote(t.plot_code) + ",htt_status_operation='LOADING',htt_place='FARM', htt_cuttingtime=" + utl.sqote(t.r_time) + ",htt_truck_distance=" + utl.sqote(data.r_distance) + " WHERE blackbox_id=" + utl.sqote(t.truck_blackbox_id);

                            iexcute(sql_harvester, function (xres1)
                            {
                                if (xres1 == 'oK')
                                {
                                    iexcute(sql_truck, function (xres2)
                                    {
                                        if (xres1 == 'oK')
                                        {
                                            //Add Harvester report Cutting
                                            data.r_status = 11;
                                            iRep.check_history_status_havester(data, t, function (gres1)
                                            {
                                                //callback(gres);
                                                //return;
                                                if (gres1 != ' ')
                                                {
                                                    //* Add Truck report Loading
                                                    data.r_status = '77'
                                                    iRep.check_history_status_havester(data, t, function (gres2)
                                                    {
                                                        callback(gres2);
                                                        return;
                                                    });
                                                }
                                            });

                                        }

                                    })
                                }

                            });

                        }
                        else
                        {
                            callback([]);
                            return;
                        }
                       
                    }
                }

            }
        
        } break;
        case 10: {
            result.val = "UNCUTTING_LOADING"; doprocess = true;
            inout.is_inconfig_polygon(data.blackbox_id, data.lon, data.lat, function (rows) {
                debugger;
                if (rows.length > 0)
                {
                    rows = rows[0];
                    if (rows.is_inzone) //inside farm's
                    {
                        var sql = "UPDATE rec_now SET htt_plotcode=" + utl.sqote(rows.zone_id) + ",htt_name_farmer=" + utl.sqote(rows.name) + " WHERE blackbox_id=" + utl.sqote(data.blackbox_id);
                        iRep.check_history_status_havester(data, rows, function (gres) { });
                    }
                }
            });

        } break;
        case 30: {
            result.val = "IN_TRANSIT";  result.cane_status = "IN_TRANSIT";
            doprocess = true;
        } break;
        case 31: {
            result.val = "IDELING";  result.cane_status = "ENGINE_ON";
            doprocess = true;
        } break;
        case 32: {
            result.val = "IDELING"; result.cane_status = "ENGINE_ON";
            doprocess = true;
        } break;
        case 33: {
            result.val = "STOP"; result.cane_status = "ENGINE_OFF";
            doprocess = true; 
        } break;
        case 34: {
            result.val = "STOP"; result.cane_status = "ENGINE_OFF";
            doprocess = true;
        } break;
    }
   
    if (doprocess) {
        set_recnow_operate(result, function (res)
        {
            debugger;
            if (result.cane_status != ' ')
            {
                dtc2cane.set_harvest_vehicle_working_current(data.htt_harvester_name + ',' + data.r_time + ',' + result.cane_status, function (xres) {
                    console.log(xres);
                });
            }

            doprocess = false;
            callback(res);
            return;
        });
    }
  
}

//เช็ครถตัดเสีย พร้อมใช้งานริไม่
function havester_useability(data, callback)
{
    // (รถตัด (สายพานลำเลียงหมุน + อยู่ในไร่)) + (รถบรรทุก อยู่ภายใน 15 เมตร)
    var st1 = false; var st2 = false;
    var result = { 'blackbox_id': ' ', 'plot_code': ' ','htt_id_lost':' ' ,'r_time':' ' };
   // result.blackbox_id = res[0]['blackbox_id'];
  //  result.r_time = res[0]['r_time'];
  //  result.htt_id_lost = res[0]['htt_id_lost'];

    if (data.htt_status_operation == 'out_of_service' && data.r_io == status_cutting)
    {
        hvt.is_infarm(data.blackbox_id, data.lon, data.lat, function (result1)
        {
            if (result1.length > 0) {
                result.plot_code = result1[0].plot_code;
            }
            st1 = true;
            fin();
        });

        hvt.has_truck_havester(data.blackbox_id, data.lon, data.lat, radius_track_and_havester, function (result2)
        {
            result.htt_id_lost = result2.htt_id_lost;
            result.blackbox_id = result2.blackbox_id;
            result.r_time = result2.r_time;
            st2 = true;
            fin();
        });

        function fin()
        {
            if (st1 && st2)
            {
                out_of_service.set_havester_ready(result, function (xres) {
                    callback(xres);
                    return;
                });
            }
        }
    }
}


//เช็ครถตัด ทำงานนอกพื้นที่
function havester_workout_zone(data, callback)
{
    var st1 = false; var st2 = false;
    var result = { 'truck_blackbox': ' ', 'plot_code': ' ', 'workout_zone': ' ', 'r_time': ' ' };
   // var x = { 'lon': '102.134222280683', 'lat': '16.4865332748977' };

    if (data.r_io == status_cutting)
    {
        hvt.is_infarm(data.blackbox_id, data.lon, data.lat, function (result1) {
            if (result1.length > 0)
            {
                result.plot_code = result1[0].plot_code; // plot_code ไม่เป็น 0 คือทำในไร่
                result.workout_zone = result1[0].is_inzone == false ? true : false; // false คือ ไม่ใช่ แปลง ที่กำหนด
              
            }
            st1 = true;
            fin();
        });

        //+ (รถบรรทุก อยู่ภายใน 15 เมตร)
        hvt.has_harvester_truck(data.blackbox_id, data.lon, data.lat, radius_track_and_havester, function (result2) {
            // result.htt_id_lost = result2.htt_id_lost;
            result.truck_blackbox = result2.blackbox_id;
            result.r_time = result2.r_time;
            st2 = true;
            fin();
        });

        function fin() {
            if (st1 && st2)
            {
                if (result.truck_blackbox != 0 && result.workout_zone == true) {
                    var para = { 'column': "htt_workout_zone", 'key': data.blackbox_id, 'val': 'workout_zone' }
                    set_recnow_operate(para, function (r) {
                        callback(r);
                        return;
                    });
                } else {
                    callback('fin');
                    return;
                }
                
            }
        }
    }
}


function harvester_stores_status_cutting(htt_status_cutting, blackbox_harvester,callback) {
    var sql_harvester = "UPDATE rec_now SET htt_status_cutting="+utl.sqote(htt_status_cutting)+" WHERE blackbox_id=" + utl.sqote(blackbox_harvester);
    iexcute(sql_harvester, function (res) {
        
        console.log(' set htt_status_cutting ' + res);
        callback(res);
        return;
    });
}

//#endregion


//#region truck

//ติดตามสถานะรถบรรทุกด้านการปฎิบัติงาน
function truck_operate(data, callback)
{
    debugger;
    var doprocess = false;
    var result = { 'column': "htt_status_operation", 'key': data.blackbox_id, 'val': '', 'cane_status': ' ','loading_harvest_vehicle_code':' ' }

    //check is finish loading and first out polygon
    if (data.htt_status_operation=='LOADING')
    {
        hvt.is_infarm(data.blackbox_id, data.lon, data.lat, function (result1)
        {
            if (result1.length == 0)//ออกจากไร่
            {
                // result.plot_code = result1[0].plot_code;
                //set truck
                var sql_truck = "UPDATE rec_now SET htt_status_operation='IN_TRANSIT', htt_status_truck='HARD',htt_place='ROAD_WITH_CANE' WHERE blackbox_id=" + utl.sqote(data.blackbox_id);

          
                var s1 = false; var s2 = false;
                var para = { 'companyCode': ' ', 'beYear': ' ', 'bpCode': ' ', 'plotCode': ' ', 'dlvVehicleCode': ' ', 'harvestVehicleCode': ' ', 'transactionId': ' ', 'cuttingTimestamp': ' ' };
                get_master_factory(function (rows)
                {
                    if (rows.length > 0) {
                        para.companyCode = rows[0].company_code
                        para.beYear = rows[0].year
                    }
                    s1 = true;
                    fin();
                })

              //  data.blackbox_id='189600110834'
                get_caneHO(data.blackbox_id, function (rows) {
                    if (rows.length > 0)
                    {
                        rows  =  rows[0];
                        para.bpCode = rows.bpcode;
                        para.plotCode = rows.plotcode;
                        para.dlvVehicleCode = rows.truck_code;
                        para.harvestVehicleCode = rows.harvester_code;
                        para.transactionId = rows.htt_transectionid;
                        para.cuttingTimestamp = rows.htt_cuttingtime;

                        result.cane_status = 'LOADING';
                        result.loading_harvest_vehicle_code = rows.harvester_code;
                    }
                    s2 = true;
                    fin();
                });


                //* call CANE Service When Finish Loading (Generate SaveHO)
                function fin()
                {
                    if (s1 && s2)
                    {
                        dtc2cane.saveHO(para, function (xres) {
                            debugger;
                            cal_delivery_vehicle_working_current(data, result);
                            console.log(xres);
                            callback(xres);
                            return;
                           //* !!!! close Truck report Loading
                            //data.r_status = '77'
                            //iRep.check_history_status_havester(data, t, function (gres2) {
                            //    callback(gres2);
                            //    return;
                            //});
                        });


                    }
                }

             
               
            }
            

        });

    } else {

        // console.log(data);

        switch (data.r_status)
        {
            case 30: {
                result.val = "IN_TRANSIT";
                result.cane_status = "IN_TRANSIT";
                cal_delivery_vehicle_working_current(data, result);
                doprocess = true;
            } break;
            case 31: {
                result.val = "IDELING";
                result.cane_status = "ENGINE_ON";
                cal_delivery_vehicle_working_current(data, result);
                doprocess = true;
            } break;

            case 32: {
                result.val = "IDELING";
                result.cane_status = "ENGINE_ON";
                cal_delivery_vehicle_working_current(data, result);
                doprocess = true;
            } break;

            case 33: {
                result.val = "STOP";
                result.cane_status = "ENGINE_OFF";
                cal_delivery_vehicle_working_current(data, result);
                doprocess = true;
            } break;

            case 34: {
                result.val = "STOP";
                result.cane_status = "ENGINE_OFF";
                cal_delivery_vehicle_working_current(data, result);
                doprocess = true;
            } break;
                //  case 66: { result.val = "LOADING"; doprocess = true; } break;
        }

        if (doprocess) {
            set_recnow_operate(result, function (res) {
                doprocess = false;
                callback(res);
                return;
            });
        }
    }
}

//เช็ครถบรรทุกเสีย พร้อมใช้งานริไม่
function truck_useability(data, callback)
{
    // (รถตัด (สายพานลำเลียงหมุน + อยู่ในไร่)) + (รถบรรทุก อยู่ภายใน 15 เมตร)
    var st1 = false; var st2 = false;
    var result = { 'blackbox_id': ' ', 'blackbox_id_harvester': ' ', 'plot_code': ' ', 'htt_id_lost': ' ', 'r_time': ' ' };

    //blackbox_id ของ รถตัด
    if (data.htt_status_operation == 'out_of_service')
    {
        hvt.is_infarm(data.blackbox_id, data.lon, data.lat, function (result1) {
            if (result1.length > 0) {
                result.plot_code = result1[0].plot_code;
            }
            st1 = true;
            fin();
        });

        hvt.has_truck_havester(data.blackbox_id, data.lon, data.lat, radius_track_and_havester, function (result2) {
            result.htt_id_lost = result2.htt_id_lost;
            result.blackbox_id_harvester = result2.blackbox_id;
            result.blackbox_id = data.blackbox_id;
            result.r_time = result2.r_time;
            st2 = true;
            fin();
        });


        function fin()
        {
            if (st1 && st2)
            {
                debugger;
                //result.plot_code = '100101004'
                //result.blackbox_id_harvester = '104090169535'

               if (result.blackbox_id_harvester != 0 && result.plot_code != " ")
                {
                    out_of_service.set_truck_ready(result, function (xres)
                    {
                        callback(xres);
                        return;
                    });
               }
                
            }
        }
    }
}


function truck_place(data, callback)
{
    debugger;
    inout.is_inpolygon(data.blackbox_id, data.lon, data.lat, function (res) {
        if (res.length > 0)
        {
            var result = [];
            var place = { 'place_th': ' ', 'place_en': ' FARM' }
            result.push(place);
            callback(result);
            return;
        }
        else
        {
            callback([]);
            return;
        }
    })

    inout.is_infactory(data.blackbox_id, data.htt_place, data.lon, data.lat, function (place)
    {
        callback(place);
        return;
    })
   

}

function cal_delivery_vehicle_working_current(data,result) 
{
    truck_place(data, function (place)
    {
        if (place.length > 0)
        {
            var cane_para = data.htt_truck_name + ',' + data.r_time + ',' + result.cane_status + ',' + place[0].place_en+','+result.loading_harvest_vehicle_code
            dtc2cane.set_delivery_vehicle_working_current(cane_para, function (xres)
            {
                console.log(xres);
            });
          
        }
    });
}

    //#endregion


//#region

function get_mile_truck(blackbox_id_truck, callback)
{
    var sql = "SELECT r_distance,htt_truck_distance,(r_distance -htt_truck_distance)as miles FROM rec_now WHERE htt_is_send_order_distance='0' AND blackbox_id=" + utl.sqote(blackbox_id_truck);
    iget_row(htt_realtime, sql, function (rows) {
        callback(rows);
        return;
    });
}

function set_already_send_orderdistance(blackbox_id_truck, flag, callback)
{
    // htt_is_send_order_distance
    flag = flag == 'send' ? '1' : '0'
    var sql = "UPDATE rec_now SET htt_is_send_order_distance=" + utl.sqote(flag) + " WHERE blackbox_id="+utl.sqote(blackbox_id_truck);
    iexcute(sql, function (res) {
        console.log(' set_already_send_orderdistance ' + res);
        callback(res);
        return;
    });
}

//set recnow
function set_recnow_operate(para, callback) {
    var query_update = squel.update()
        .table('rec_now')
        .set(para.column, para.val)
        .where('blackbox_id = ' + utl.sqote(para.key))
        .toString();

    iexcute(query_update, function (res) {
        callback(res);
        return;
    });
}

function get_master_factory(callback)
{
    var sql = "SELECT company_code,year FROM master_factory_config WHERE is_master=true";
    iget_row(pg_htt, sql, function (rows)
    {
        callback(rows);
        return;
    });
}

function get_caneHO(blackbox_id,callback) 
{
    var sql=" ";
    sql +=" SELECT "
    sql +=" htt_qt as bpcode "
    sql +=",htt_plotcode as plotcode "
    sql +=",htt_harvester_name as truck_code "
    sql +=",htt_truck_name as harvester_code "
    sql +=",htt_transectionid "
    sql +=",to_char(htt_cuttingtime, 'YYYY-MM-DD HH24:MI:SS') as htt_cuttingtime "
    sql +="FROM rec_now WHERE blackbox_id="+utl.sqote(blackbox_id) //'189600110834'
    iget_row(htt_realtime, sql, function (res) {
        callback(res);
        return;
    });
}

function iget_row(connection,sql,callback)
{
    db.get_rows(connection, sql, function (rows) {
        callback(rows);
        return;
    });
}

function iexcute(sql,callback) {
    db.excute(htt_realtime, sql, function (response) {
        if (response == 'oK') {
           // console.log('Update-Complete');
            callback(response);
            return;
        } else {
            console.log('Update-failed');
            callback(response);
            return;
        }
    });
}

    //#endregion


//#region datatest
    //lon: 102.195250325693, lat:16.4149841094033

   // lon: 102.075633, lat: 16.406717,
    //		
var data = {
    blackbox_id: '104090170224',
    r_time: '2015-09-21 18:58:49',
    r_status: 11,
    lon: 102.195250325693, lat:16.4149841094033,
    r_speed: 0,
    tambol: 'โนนคูณ',
    amphur: 'คอนสาร',
    province: 'ชัยภูมิ',
    htt_status_operation: 'IDELING',
    htt_status_useability: 'ready',
    htt_status_truck: null,
    htt_plotcode: '100102006',
    htt_place: 'ROAD',
    htt_havester: '1',
    htt_id_lost: null,
    htt_workout_zone: null,
    htt_name_farmer: '-102   -',
    htt_phone_farmer: null
}

//#endregion


//#region export
exports.havester_operate = havester_operate;
exports.havester_useability = havester_useability;
exports.havester_workout_zone = havester_workout_zone;
exports.harvester_stores_status_cutting = harvester_stores_status_cutting;


exports.truck_place = truck_place;
exports.truck_useability = truck_useability;
exports.truck_operate = truck_operate;

exports.get_mile_truck = get_mile_truck;
exports.set_recnow_operate = set_recnow_operate; 
exports.set_already_send_orderdistance = set_already_send_orderdistance;
//#endregion





//#region timeout
    /*
setTimeout(function ()
{
    //recnow_operate(data, function (x) {
    //    console.log(x);
    //});
    //102.134222280683, 16.4865332748977

    debugger;

  //  console.log(inow);
 

    //truck_useability(data_recnow_truck, function (x) {})
    //recnow_useability_havester(data);
    //  recnow_workout_zone(data_recnow_workout_zone);

   // truck_place(data_recnow_truck_place, function (x) { });

  //  recnow_truck_finish_loading();
  

  //  recnow_match_harvester_truck();
    //  recnow_truck_operate_finish_loading()
     recnow_truck_place();
}, 1000);

*/


//step1
function recnow_match_harvester_truck()
{
    debugger;
    var data = {
        'blackbox_id': '189600101733', 'r_time': '2015-11-05 15:43:41'
  , 'r_io': 11
    , 'r_status': ' '
  , 'r_status_old': ' '
  , 'lon': '102.123'
  , 'lat': '16.4775'
  , 'r_speed': '20', 'r_distance': 44.508785
  , 'htt_status_operation': 'ENGINE_OFF'
 
    }

    havester_operate(data, function (x) {
        console.log(x);
    });
}

//step2
function recnow_truck_operate_finish_loading() {

    var data = {
        'blackbox_id': '189600128641', 'r_time': '2015-11-05 15:43:41'
    , 'r_status': 33
    , 'r_status_old': ' '
        //, 'lon': '102.134222280683'
        //, 'lat': '16.4865332748977'
    , 'lon': '101.99815'
    , 'lat': '16.520133'
    , 'r_speed': '20'
    , 'htt_status_operation': 'LOADING'
    , 'htt_place': 'FARM'
    }

    truck_operate(data, function (res) {
        console.log(res);
    });
}

//step3
function recnow_truck_place() {

    var data = {
        'blackbox_id': '189600128641', 'r_time': '2015-11-05 15:43:41'
    , 'r_status': 33
    , 'r_status_old': ' '
    , 'lon': '101.99815'
    , 'lat': '16.520133'
    , 'r_speed': '20'
    , 'htt_status_operation': 'LOADING'
    , 'htt_place': 'FARM'
    }

    truck_place(data, function (res) {
        console.log(res);
    });
}

//truck_operate
function recnow_truck_finish_loading()
{
    var data = {
        'blackbox_id': '189600110834', 'r_time': '2015-11-05 16:43:41'
  , 'r_status': 10
  , 'r_status_old': ' '
        , 'lon': '101.99815'
        , 'lat': '16.520133'
  , 'r_speed': '20', 'r_distance': 88.508785
  , 'htt_status_operation': 'LOADING'
    }

    var data2 = {
        'blackbox_id': '189600110834', 'r_time': '2015-11-05 16:43:41'
 , 'r_status': 30
 , 'r_status_old': ' '
    , 'lon': '101.99815'
    , 'lat': '16.520133'
    , 'r_speed': '20'
    , 'htt_status_operation': 'out_of_service'
    , 'htt_place': 'park_inside'
    , 'htt_truck_name': 'K004019'
    }

    truck_operate(data2, function (x) {
        console.log(x);
    });
}



function recnow_workout_zone()
{
    var data_recnow_workout_zone = {
        'blackbox_id': '189600110834', 'r_time': '2015-11-05 16:43:41'
    , 'r_status': 10
    , 'r_status_old': ' '
        //, 'lon': '102.134222280683'
        //, 'lat': '16.4865332748977'
    , 'lon': '101.99815'
    , 'lat': '16.520133'
    , 'r_speed': '20'
    , 'htt_status_operation': 'out_of_service'
    }

}

function recnow_truck() {

    var data_recnow_truck = {
        'blackbox_id': '189600110834', 'r_time': '2015-11-05 15:43:41'
       , 'r_status': 10
       , 'r_status_old': ' '
        //, 'lon': '102.134222280683'
        //, 'lat': '16.4865332748977'
       , 'lon': '101.99815'
       , 'lat': '16.520133'
       , 'r_speed': '20'
       , 'htt_status_operation': 'out_of_service'
    }

}

/*
UPDATE rec_now SET r_status='33' WHERE blackbox_id='104090170325'
*/

    //#endregion


