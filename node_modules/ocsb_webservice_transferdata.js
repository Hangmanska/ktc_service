
var mustache = require("mustache");
var timespan = require('timespan');
var moment = require('moment');

var async = require('async');
var squel = require("squel");
var linq = require('linq.js');
var db = require('iConnectdb_ktc.js');

var iconn = require('conn_sugar_cane.js');
var pg_htt = new db.im2(iconn.get_dbconfig_htt());
var ipm = new db.im2(iconn.get_dbconfig_realtime());
var inout = require('inout_polygon.js');

var db_config = "master_config";
var db_sugarcane = "sugarcane";
var db_owner = "db_10003";

var utl = require('Utility.js');
var utcp = require('Utility_tcp.js');
var db_config = "master_config";

var result_final =[];

function getmaster_vehicle_tankwater(callback)
{
    //to_char(now(), 'YYYY-MM-DD')
  // var sql = "SELECT modem_id,vehiclename as harvester_name,'"+date_process+"' as date_process FROM tankwater_register";
   
   var sql = "  SELECT r.modem_id ";
   sql += ",get_vehiclename_fleet(r.modem_id,r.fleet_id) as vehicle_name";
  // sql += ",idate(gps_datetime) as date_process ";
   sql += " FROM	realtime as r, setup_vehicle as sv";
   sql += " WHERE	r.modem_id=sv.modem_id ";
   sql += " AND r.fleet_id=sv.fleetid ";
  //AND r.modem_id='1010003082' ";
   sql += " AND sv.fleetcode=get_fleetid('watertank') ";
  // sql += " AND to_char(gps_datetime,'YYYY-MM-DD')='2018-11-08' ";

   ipm.db.dbname = db_config;
    db.get_rows(ipm, sql, function (res_ar) 
    {
        callback(res_ar);
        return;
          /* 
          debugger;
             async.eachSeries(res_ar, function (row, next)
             {
                
                 console.log(row.modem_id,date_process);
                gen_data(row.modem_id,date_process,function(xres)
                {
                    if(xres)
                    {
                        next();
                    }
                });

             },function(){
                 console.log('finish');
               //  callback(true);
               callback(result_final);
                 return;
             });
             */
            
    });

}


function getdata_watertank(modem_id,date_process,callback)
{
    var detail = { 'data': '', 'max_time': '' };

    var sql = " SELECT modem_id,idate(gps_datetime) as gps_datetime,status,speed,lat,lon,tambol,amphur,province";
    sql += " FROM ht_"+modem_id //1010003082
    sql += " WHERE gps_datetime >'"+date_process+"'";
    sql += " ORDER BY gps_datetime LIMIT 5000";

    ipm.db.dbname = db_owner;
    db.get_rows(ipm, sql, function (ar_data) 
    {
       // result_final.push(ar_data);

       if (ar_data.length > 0) 
       { 
        var max_datetime = linq.Enumerable.From(ar_data)
        .Select(function (x) { return x.gps_datetime })
        .Max();

          debugger;
        //  console.log(max_datetime)
          detail.data = ar_data;
          detail.max_time = max_datetime;

          callback(detail);
          return;
        }
        else
        {
            callback([]);
            return;
        }


          /*
        if (ar_data.length > 0) 
        { 
            var strMustache = '{{#.}}';
            strMustache += "'{{gps_datetime}}','{{modem_id}}','{{status}}','{{speed}}','{{lat}}','{{lon}}','{{tambol}}','{{amphur}}','{{province}}'";
            strMustache += "|";
            strMustache += '{{/.}}';
        

          //  var tb_name = 'harvester_sumary_working_speed';
        
            var result_val = mustache.render(strMustache, ar_data);
            result_val = utl.iRmend(result_val);
            result_final.push(result_val);
            callback(true);
            return;
        }
        else
        {
            callback(false);
            return;
        }
        */
    });

}

/*
getdata_watertank('1010003082','2018-10-31 00:00:00',function(ress)
{
    console.log(ress)
})

getvehicle_tankwater(function(ress)
{
    console.log(ress)
});
*/
//exports.getdata_tankwater = getdata_tankwater;