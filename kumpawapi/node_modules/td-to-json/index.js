const cheerio = require('cheerio');
const request = require('request-promise');

const convertHtml = function(html, options) {
  if (!options.columnHeaders || options.columnHeaders.length === 0) {
    throw new Error('please provide column Headers');
  }

  options = Object.assign({
    tableNum: null,
    skipFirstRow: false,
  }, options)

  const $ = cheerio.load(html);

  const jsonResponse = [];
  const alreadySeen = [];

  $('table').each((i, table) => {
    if (options.tableNum && i !== options.tableNum) { return };
    const rows = $(table).find('tr');
    const tableAsJson = [];
    const headings = options.columnHeaders

    rows.each((i, row) => {
      const jsonObject = {}
      if (options.skipFirstRow && i === 0) { return }
      const values = $(row).find('td, th');
      values.each((j, cell) => {
        const text = $(cell).text().trim()
        jsonObject[headings[j]] = text
      });
      tableAsJson.push(jsonObject);
    });

    return tableAsJson;
  });

}

const convertUrl = async (url, options) => {
  const res = await request(url)
  convertHtml(res, options)
}

exports.convertUrl = convertUrl;

exports.convertHtml = convertHtml