var moment = require('moment');
var linq = require('linq.js');

//http://snipplr.com/view/16591/

exports.Left = function(str, n) {
    if (n <= 0)
        return "";
    else if (n > String(str).length)
        return str;
    else
        return String(str).substring(0, n);
}

exports.Right = function(str, n) {
    if (n <= 0)
        return "";
    else if (n > String(str).length)
        return str;
    else {
        var iLen = String(str).length;
        return String(str).substring(iLen, iLen - n);
    }
}

exports.Val = function(data) {
    return parseInt(data, 10);
}

//http://www.4guysfromrolla.com/webtech/code/Mid.shtml
exports.Mid = function(str, start, len)
  
    /***
            IN: str - the string we are LEFTing
                start - our string's starting position (0 based!!)
                len - how many characters from start we want to get

            RETVAL: The substring from start to start+len
    ***/ {
    // Make sure start and len are within proper bounds
    start = start - 1; //for collect follow Bom
    if (start < 0 || len < 0) return "";

    var iEnd, iLen = String(str).length;
    if (start + len > iLen)
        iEnd = iLen;
    else
        iEnd = start + len;

    return String(str).substring(start, iEnd);
}

//http://royaltutorials.com/javascript-parsedouble/
exports.parseDouble = function(value) {
    if (typeof value == "string") {
        value = value.match(/^-?\d*/)[0];
    }

    return !isNaN(parseInt(value)) ? value * 1 : NaN;
}


//http://jalaj.net/blog/2012/09/13/hex-to-from-ascii-in-javascript/
//alert(asc2hex('How are you?'));
//alert(hex2asc('4920616d2066696e6521'));

exports.asc2hex = function(pStr) {
    tempstr = '';
    for (a = 0; a < pStr.length; a = a + 1) {
        tempstr = tempstr + pStr.charCodeAt(a).toString(16);
    }
    return tempstr;
}

exports.hex2asc = function(pStr) {
    tempstr = '';
    for (b = 0; b < pStr.length; b = b + 2) {
        tempstr = tempstr + String.fromCharCode(parseInt(pStr.substr(b, 2), 16));
    }
    return tempstr;
}

//http://blog.loftdigital.com/blog/trim-a-string-in-javascript
 function Trim(str) {
    var trimmed = str.replace(/^\s+|\s+$/g, '');
    return trimmed;
 }
 exports.Trim = Trim;

function iRmend(s) {
    var s = s.substring(0, s.length - 1);
    return Trim(s);
}
exports.iRmend = iRmend;

/*
public string[] split_lng(string a, string length)
{
      string[] iar = System.Text.RegularExpressions.Regex.Split(a, "(?<=\\G.{" + length + "})");
return iar;
}*/

function is_undefined(v,callback){
    if (typeof v === 'undefined') {
        callback(true);
        return;
    } else {
        callback(false);
        return;
    }
}
exports.is_undefined = is_undefined;

function isnull(s, val) {
    val = s === null ? val : s;
    return val;
}
exports.isnull = isnull;

function isempty(s,val) {
    if (s == '') {
        return val;
    } else {
        return s;
    }
}
exports.isempty = isempty;

function isNumber(value) {
    if ((undefined === value) || (null === value)) {
        return false;
    }
    if (typeof value == 'number') {
        return true;
    }
    return !isNaN(value - 0);
}
exports.isNumber = isNumber;


/*
I borrowed that regex from http://www.codetoad.com/javascript/isnumeric.asp. Explanation:

/^ match beginning of string
-{0,1} optional negative sign
\d* optional digits
\.{0,1} optional decimal point
\d+ at least one digit
$/ match end of string
*/

function IsNumeric(input) {
    var RE = /^-{0,1}\d*\.{0,1}\d+$/;
    return (RE.test(input));
}

exports.IsNumeric = IsNumeric;


exports.QLat = function (hexlon) {
    
    this.xlon1 = this.Left(hexlon, 2);
    this.xlon2 = this.Right(hexlon, 5);
    this.result = hex2dec(xlon1) + "." + hex2dec(xlon2);
    return result;
}

exports.QLon = function(hexlon) {
    this.xlon1 = this.Right(hexlon, 2);
    this.xlon2 = this.Left(hexlon, 5);
    this.result = hex2dec(xlon1) + "." + hex2dec(xlon2);//String.format("{0:0.00000}",);
    return result;
}

exports.OLat = function(hexlat) {
    this.xlat1 = this.Left(hexlat, 2);
    this.xlat2 = this.Right(hexlat, 4);
    this.result = parseDouble(hex2dec(xlon1)) + parseDouble(hex2dec(xlon2)) / 60000;//String.format("{0:0.00000}",);
    return result;
}

exports.OLon = function(hexlon) {
    this.xlon1 = this.Left(hexlon, 4);
    this.xlon2 = this.Right(hexlon, 4);
    this.result = parseDouble(hex2dec(xlon1)) + parseDouble(hex2dec(xlon2)) / 60000;//String.format("{0:0.00000}",);
    return result;
}

exports.QIO = function(io2bit, io8bit) {
    io2bit + hex2bin(io8bit);
}

exports.Q10Bit2Long = function(q2bit, q8bit) {
    this.t = q2bit + hex2bin(q8bit);
    return t = this.bin2dec(t);
}

exports.QValue = function(status, a) {
    this.value = "";
    if (status == "32" || status == "34") {

    } else {
        value = hex2dec(a);
    }
    return value;
}

exports.BCD_to_TwoBit=function(hex_in, PosBit) {
    this.Temp_msb;
    this.Temp_lsb;
    this.Temp_sum;

    Temp_msb = this.hex2bin(this.Left(hex_in, 1));
    Temp_lsb = this.hex2bin(this.Right(hex_in, 1));
    Temp_sum = Temp_msb + Temp_lsb;
    this.BCD = '';
    switch (PosBit) {
        case 1: { BCD = this.bin2dec(this.Mid(Temp_sum, 1, 2)); } break;
        case 2: { BCD = this.bin2dec(this.Mid(Temp_sum, 3, 2)); } break;
        case 3: { BCD = this.bin2dec(this.Mid(Temp_sum, 5, 2)); } break;
        default: { BCD = this.bin2dec(this.Mid(Temp_sum, 7, 2)); } break;
    }
    return BCD;
}

exports.Sformat = function () {
    // The string containing the format items (e.g. "{0}")
    // will and always has to be the first argument.
    var theString = arguments[0];

    // start with the second argument (i = 1)
    for (var i = 1; i < arguments.length; i++) {
        // "gm" = RegEx options for Global search (more than one instance)
        // and for Multiline search
        var regEx = new RegExp("\\{" + (i - 1) + "\\}", "gm");
        theString = theString.replace(regEx, arguments[i]);
    }

    return theString;
}


//http://rickyrosario.com/blog/javascript-startswith-and-endswith-implementation-for-strings/
exports.StartsWith = function(str, prefix) {
    return str.indexOf(prefix) === 0;
}

exports.EndsWith = function(str, suffix) {
    return str.match(suffix + "$") == suffix;
}

//http://stackoverflow.com/questions/1789945/method-like-string-contains-in-javascript
exports.Contains = function(data,it) {
        return data.indexOf(it) != -1;
};


exports.FormatNumber = function(num, prefix) {
    prefix = prefix || '';
    num += '';
    var splitStr = num.split('.');
    var splitLeft = splitStr[0];
    var splitRight = splitStr.length > 1 ? '.' + splitStr[1] : '';
    var regx = /(\d+)(\d{3})/;
    while (regx.test(splitLeft)) {
        splitLeft = splitLeft.replace(regx, '$1' + ',' + '$2');
    }
    return prefix + splitLeft + splitRight;
}

exports.FormatNumbers= function(num, digit) {
    return num.toFixed(digit);
}

exports.unformatNumber = function(num) {
    return num.replace(/([^0-9\.\-])/g, '') * 1;
}


var convertBase = function (num) {
    this.from = function (baseFrom) {
        this.to = function (baseTo) {
            return parseInt(num, baseFrom).toString(baseTo);
        };
        return this;
    };
    return this;
};

// binary to decimal
exports.bin2dec = function (num) {
    return convertBase(num).from(2).to(10);
};

// binary to hexadecimal
exports.bin2hex = function (num) {
    return zeroPad(convertBase(num).from(2).to(16), 4);
};

// decimal to binary
exports.dec2bin = function (num) {
    return convertBase(num).from(10).to(2);
};

// decimal to hexadecimal
exports.dec2hex = function (num) {
    return convertBase(num).from(10).to(16);
};

// hexadecimal to binary
exports.hex2bin = function (num) {
    return zeroPad(convertBase(num).from(16).to(2), 4);
};

// hexadecimal to decimal
exports.hex2dec = function (num) {
    return convertBase(num).from(16).to(10);
};

function zeroPad(num, places) {
    var zero = places - num.toString().length + 1;
    return Array(+(zero > 0 && zero)).join("0") + num;
}
exports.zeroPad = zeroPad;

//http://www.tylerfrankenstein.com/user/4/code/javascript-date-time-yyyy-mm-dd-hh-mm-ss
exports.format_date = function (now) {
    //debugger;
    now = now != '' ? now :  now = new Date();
    year = "" + now.getFullYear();

    month = "" + (now.getMonth() + 1); if (month.length == 1) { month = "0" + month; }
    day = "" + now.getDate(); if (day.length == 1) { day = "0" + day; }
    hour = "" + now.getHours(); if (hour.length == 1) { hour = "0" + hour; }
    minute = "" + now.getMinutes(); if (minute.length == 1) { minute = "0" + minute; }
    second = "" + now.getSeconds(); if (second.length == 1) { second = "0" + second; }
    result = year + "-" + month + "-" + day + " " + hour + ":" + minute + ":" + second;

    return result;
}

exports.format_date_only = function (now) {
    //debugger;
    now = now != '' ? now : now = new Date();
    year = "" + now.getFullYear();

    month = "" + (now.getMonth() + 1); if (month.length == 1) { month = "0" + month; }
    day = "" + now.getDate(); if (day.length == 1) { day = "0" + day; }
    hour = "" + now.getHours(); if (hour.length == 1) { hour = "0" + hour; }
    minute = "" + now.getMinutes(); if (minute.length == 1) { minute = "0" + minute; }
    second = "" + now.getSeconds(); if (second.length == 1) { second = "0" + second; }
    result = year + "-" + month + "-" + day ;

    return result;
}

 function replaceAll (find, replace, str) {
    return str.replace(new RegExp(find, 'g'), replace);
 }
 exports.replaceAll = replaceAll;

exports.diff = function (date1, date2, parts)
{
    var d1 = new Date(date1.getTime()),
		d2 = new Date(date2.getTime()),
		pm = d1 <= d2 ? 1 : -1,
		result = {},
		factors = { weeks: (1000 * 60 * 60 * 24 * 7), days: (1000 * 60 * 60 * 24), hours: (1000 * 60 * 60), minutes: (1000 * 60), seconds: 1000, milliseconds: 1 };

    if (parts === undefined)
        parts = ['years', 'months', 'weeks', 'days', 'hours', 'minutes', 'seconds', 'milliseconds'];
    else if (typeof (parts) == "string")
        parts = [parts];

    for (var i = 0, l = parts.length; i < l; i++) {
        var k = parts[i];
        result[k] = 0;

        if (factors[k] === undefined) {
            inaWhile: while (true) {
                d2.adjust(k, -1 * pm);
                if ((pm === 1 && d1 > d2) || (pm === -1 && d1 < d2)) {
                    d2.adjust(k, 1 * pm);
                    break inaWhile;
                }
                result[k]++;
            }
        }
        else {
            var tmpDiff = Math.abs(d2.getTime() - d1.getTime());
            result[k] = Math.floor(tmpDiff / factors[k]);
            d2.adjust(k, result[k] * -1 * pm);
        }
        result[k] *= pm;
    }

    if (parts.length == 1)
        return result[parts[0]];
    return result;
}
//http://trentrichardson.com/2011/09/27/better-javascript-date-add-and-diff/

//+++++++++++++++++ PostGresql ++++++++++++++++++

exports.sqote = function (s) {
    return "'" + s + "'";
}


function fixed(num)
{
    //debugger;
    num = roundTo2Decimals(num);
    return num;//num.toString().toFixed(2);
}
exports.fixed = fixed;

function roundTo2Decimals(numberToRound) {
    return Math.round(numberToRound * 100) / 100
}


exports.fn_formate_date_iso = function (d1) {
    var s = d1.split(' ');
    var dd = exports.replaceAll(':', '-', s[1].toString());
    var str = s[0] + '-' + dd;


    // var str =s.replace(' ', '-').replace(':', '-');

    var p = str.split("-");
    var date = new Date(p[0], p[1], p[2], p[3], p[4], p[5]);
    return date;
}

function format_time(dt) {
    var res = moment(dt).format("YYYY-MM-DD HH:mm:ss");
    return res;
}
exports.format_time = format_time;

function format_times(dt) {
    var res = moment(dt).format("YYYY-MM-DD HH:mm:ss.SSS");
    return res;
}
exports.format_times = format_times;

function format_date(dt) {
    var res = moment(dt).format("YYYY-MM-DD");
    return res;
}
exports.format_date = format_date;


function iformat_date(dt,format) {
    var res = moment(dt).format(format);
    return res;
}
exports.iformat_date = iformat_date;

function format_timeunix_tonormal(dateStr) {
   // var dateStr = "20141204090200";
    var match = dateStr.match(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/);
    var s = match[1] + '-' + match[2] + '-' + match[3] + ' ' + match[4] + ':' + match[5];
    //console.log(s);
    return s;
}
exports.format_timeunix_tonormal = format_timeunix_tonormal;


//http://stackoverflow.com/questions/8098202/javascript-detecting-valid-dates
function is_valid_date(dateString)
{
    //console.log(dateString+" "+id);

    //debugger;
    /*if (exports.StartsWith(dateString, 'NaN') || exports.EndsWith(dateString,'NaN')) {
        return false;
    } else {
        var m = moment(dateString);
        return m.isValid();
    }
   */
    var date = Date.parse(dateString);
   // var xx = type(date);
    if (isNaN(date)) {
        return false;
    }

 

    var comp = dateString.split('-');

    if (comp.length !== 3) {
        return false;
    }

    var y = parseInt(comp[0], 10);
    var m = parseInt(comp[1], 10);
    var d = parseInt(comp[2], 10);
  
    var date = new Date(y, m - 1, d);

    var m = moment(date);
    return m.isValid();
   
}
exports.is_valid_date = is_valid_date;

function islat_lng(lat,lng)
{
var b = false;

    if (lng.length <= 10 && lat.length <= 10)
    {
        var dlng = parseFloat(lng);//double.Parse(lng);
        var dlat = parseFloat(lat);//double.Parse(lat);

        try
        {
            if (dlng <= -180 || dlng <= 180 && dlat > 0.0 || dlng > 0.0)
            {
                if (dlat <= -90 || dlat <= 90)
                {
                    b = true;
                }
            }
        }
        catch(e)
        {
            
            b = false;
        }
    }

 return b;
}
exports.islat_lng = islat_lng;

function type(o) {
    return !!o && Object.prototype.toString.call(o).match(/(\w+)\]/)[1];
}



function Split(data, spliter) {
    return data.split(spliter);
}
exports.Split = Split;


function array2str(json_ar, spliter, key_or_val) {
    var select = key_or_val == "key" ? "$.Key" : "$.Value";
    var val=' ';
   if (json_ar != 0) {
        val = linq.Enumerable.From(json_ar)
          .Select(select)
          .ToString(spliter);
        return val;
    } else {
        return val;
    }

}
exports.array2str = array2str;

function remove_u0000(data) {
    data = replaceAll('\u0000', '0', data);
    return data;
}
exports.remove_u0000 = remove_u0000;

function timenow()
{
    return moment().format('YYYY-MM-DD HH:mm:ss');
}
exports.timenow = timenow;

//0000 0000 1001 0000

//setTimeout(function ()
//{
//    debugger;
//    for (var i = 1; i <= 14; i++) {
//        console.log(zeroPad(i, 2));
//    }

//}, 1000);


/** Converts numeric degrees to radians */
if(typeof(Number.prototype.toRad) === "undefined") {
    Number.prototype.toRad = function () {
        return this * Math.PI / 180;
    }
}

//https://gist.github.com/mattpowell/3380070

// start and end are objects with latitude and longitude
//decimals (default 2) is number of decimals in the output
//return is distance in kilometers. 
 function getDistance(start, end, decimals) {
    decimals = decimals || 2;
    var earthRadius = 6371; // km
    lat1 = parseFloat(start.latitude);
    lat2 = parseFloat(end.latitude);
    lon1 = parseFloat(start.longitude);
    lon2 = parseFloat(end.longitude);

    var dLat = (lat2 - lat1).toRad();
    var dLon = (lon2 - lon1).toRad();
    var lat1 = lat1.toRad();
    var lat2 = lat2.toRad();

    var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    var d = earthRadius * c;
    return Math.round(d * Math.pow(10, decimals)) / Math.pow(10, decimals);
};


exports.getDistance = getDistance;