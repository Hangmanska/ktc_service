
var squel = require("squel");

var aut  = require('master_authen.js')
var utl = require('Utility.js');
var db = require('iConnectdb_ktc.js');
var ipm = new db.im2(db.get_configdb_tcp());
var db_config = "master_config";

function set_masterfile(req,res)
{
    debugger
     var b = req.body;

    // console.log(req)
  //  aut.Isauthenticate(req, res, function () {
           
        /*
            var para={
            'dlt_id':'1กข1234'
            ,'dlt_type':'TOYOTA'
            ,'chassis_no':'MXKFM1XK1XHX12999'
            ,'register_type': '2920' //ภาคพนวก ข แบ่งตาม พรบ.ขนส่งทางบก
            ,'card_reader':'1' //1 ติดเครื่องรูด 0 ไม่ติด
            ,'province_code':'001' //ภาคพนวก ค
            ,'modem_id':'1010001099'
            };   
  */
      

        
                var para={
            'dlt_id':b.dlt_id
            ,'dlt_type':b.dlt_type
            ,'chassis_no':b.dlt_chassis_no
            ,'register_type':b.dlt_register_type
            ,'card_reader':b.dlt_card_reader
            ,'province_code':b.dlt_province_code
            ,'modem_id':b.modem_id
        };   
            
      //  console.log(para)

/*
                var query = squel.update()
            .table('master_config_vehicle')
            .set('dlt_vehicle_id',para.dlt_id)
            .set('dlt_vehicle_type', para.dlt_type)
            .set('dlt_vehicle_chassis_no', para.chassis_no)
            .set('dlt_vehicle_register_type', para.register_type)
            .set('dlt_card_reader', para.card_reader)
            .set('dlt_province_code', para.province_code)
            .set('dlt_result','null')
            .where('modem_id = ' + utl.sqote(para.modem_id))
            .toString();
            */

            if(para.dlt_id.length !='7')
            {
                res.send('Please fill dlt_id 7 digit like this 0819086');
            }
            else if(utl.Contains(para.chassis_no,'-'))
            {
                res.send('Please remove - from dlt_chassis_no like this FM187LA14015');
            }else{

                var query =" ";
                query +=" UPDATE master_config_vehicle SET ";
                query +="dlt_vehicle_id='"+para.dlt_id+"' ";
                query +=",dlt_vehicle_type='"+para.dlt_type+"' ";
                query +=",dlt_vehicle_chassis_no='"+para.chassis_no+"' ";
                query +=",dlt_vehicle_register_type='"+para.register_type+"' ";
                query +=",dlt_card_reader='"+para.card_reader+"' ";
                query +=",dlt_province_code='"+para.province_code+"' ";
                query +=",dlt_model_id='1210002' ";
                query +=",has_card_reader='1' ";
                query +=",dlt_result=null ";
                query +=" WHERE modem_id='"+para.modem_id+"' ";
    
     //res.send(query);
         
                ipm.db.dbname = db_config;
                db.excute(ipm, query, function (response) 
                {
                    if (response == 'oK') 
                    {
                        res.send(response);
                    }
                    else 
                    {
                        res.send([]);
                    }
                });

            }


    

   //  });

}

function check_dltok(req,res)
{
    var b = req.body;

    var query =" ";

   query +=" SELECT dlt_result,modem_id,dlt_card_reader,dlt_vehicle_chassis_no ";
   query +=" ,dlt_province_code ";
   query +=" ,dlt_vehicle_id ";
   query +=" FROM master_config_vehicle ";
   query +="  WHERE modem_id='"+b.modem_id+"' ";

  // console.log(query);

   ipm.db.dbname = db_config;
   db.get_rows(ipm, query, function (rows)
   {
       if (rows.length > 0 ) 
       {
           res.send(rows);
       }
       else 
       {
           res.send('not found this modem_id '+b.modem_id);
       }
   });

}

exports.set_masterfile = set_masterfile;
exports.check_dltok = check_dltok;

/*
setTimeout(function ()
{
debugger;
set_masterfile('','');

}, 1000);
*/