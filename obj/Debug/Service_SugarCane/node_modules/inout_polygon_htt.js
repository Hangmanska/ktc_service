
//#region modules
var mustache = require("mustache");
var moment = require('moment');

var utcp = require('Utility_tcp.js');
var utl = require('Utility.js');
var db = require('iConnectdb_ktc.js');
var iconn = require('conn_sugar_cane.js');
var pg_query = new db.im2(iconn.get_dbconfig_htt());
var pg_htt = new db.im2(iconn.get_dbconfig_htt());
var pg_realtime = new db.im2(iconn.get_dbconfig_realtime());
    //var utcp = require('Utility_tcp.js');
var linq = require('linq.js');

var irec_now = require('htt_master_realtime.js');

var dtc2cane = require('dtc2cane.js');
//var time_now = moment().format('YYYY-MM-DD HH:mm:ss');

var time_now = {
    now: function () { return moment().format('YYYY-MM-DD HH:mm:ss'); }
};


function create_time() {
    return time_now.now();
}

//#endregion



function is_inconfig_polygon(blackbox_id, lon, lat,callback)
{

     //var sql = "WITH FID as (SELECT f_id FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 )";
     //sql += " SELECT (SELECT f_id FROM FID),position((SELECT f_id FROM FID) IN plot_code) "; //,plot_code
    //sql +=" FROM htt5 WHERE harvester_number='CH-17' ";
    //102.195250325693,16.4149841094033
    var result = [];
    //ST_Buffer_Meters(wkt_geom, 20)
    var sql ="WITH xID as "
    sql += "(SELECT f_id FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 ) ";
    sql += " SELECT position( (SELECT f_id FROM xID) IN (SELECT array_to_string(array(	SELECT dh.plot_code FROM  detail_havester as dh ,htt1 WHERE dh.havest_vehicle_code=get_harvester("+utl.sqote(blackbox_id)+") AND dh.plot_code =htt1.f_id), ',') AS f_id) ) ";
    sql += ",(SELECT f_id  FROM xID) ";
    sql += ",(SELECT zone_id FROM htt1 WHERE f_id=(SELECT f_id FROM xID) LIMIT 1) ";
    sql += ",(SELECT qt FROM htt1 WHERE f_id=(SELECT f_id FROM xID) LIMIT 1) ";
    sql += ",(SELECT name FROM htt1 WHERE f_id=(SELECT f_id FROM xID) LIMIT 1) ";
    sql += ", get_harvester(" + utl.sqote(blackbox_id) + ") as harvester_name ";
    sql += " FROM xID ";

  debugger;
     db.get_rows(pg_query, sql, function (rows)
    {
        if (rows.length > 0)
        {
            debugger;
            result.push({ 'plot_code': ' ', 'is_inzone': ' ','zone_id':' ','name':' ','qt':' ','harvester_name':' ' });
         //   console.log(rows[0]['f_id']);
           // console.log(rows[0]['position']);
            result[0].plot_code = rows[0]['f_id'];
            result[0].is_inzone = rows[0]['position'] > 0 ? true : false;
            result[0].zone_id = rows[0]['zone_id'];
            result[0].name = rows[0]['name'];
            result[0].qt = rows[0]['qt'];
            result[0].harvester_name = rows[0]['harvester_name'];
            callback(result);
            return;
        } else {
            callback(result);
            return;
        }
    });

//SELECT position((SELECT f_id FROM FID) IN plot_code),plot_code
//FROM htt5
//WHERE harvester_number='CH-17'
}


function is_inconfig_polygon_buffer(blackbox_id, lon, lat,buffer, callback) {

    //var sql = "WITH FID as (SELECT f_id FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 )";
    //sql += " SELECT (SELECT f_id FROM FID),position((SELECT f_id FROM FID) IN plot_code) "; //,plot_code
    //sql +=" FROM htt5 WHERE harvester_number='CH-17' ";
    //102.195250325693,16.4149841094033
    //ST_BUFFER(wkt_geom::geography,20)::geometry
    var result = [];
    //ST_Buffer_Meters(wkt_geom, 20)
    var sql = "WITH xID as "
    sql += "(SELECT f_id FROM htt1 WHERE ST_Contains(ST_BUFFER(wkt_geom::geography,"+buffer+")::geometry, ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 ) ";
    sql += " SELECT position( (SELECT f_id FROM xID) IN (SELECT array_to_string(array(	SELECT dh.plot_code FROM  detail_havester as dh ,htt1 WHERE dh.havest_vehicle_code=get_harvester(" + utl.sqote(blackbox_id) + ") AND dh.plot_code =htt1.f_id), ',') AS f_id) ) ";
    sql += ",(SELECT f_id  FROM xID) ";
    sql += ",(SELECT zone_id FROM htt1 WHERE f_id=(SELECT f_id FROM xID) LIMIT 1) ";
    sql += ",(SELECT qt FROM htt1 WHERE f_id=(SELECT f_id FROM xID) LIMIT 1) ";
    sql += ",(SELECT name FROM htt1 WHERE f_id=(SELECT f_id FROM xID) LIMIT 1) ";
    sql += ", get_harvester(" + utl.sqote(blackbox_id) + ") as harvester_name ";
    sql += " FROM xID ";

    debugger;
    db.get_rows(pg_query, sql, function (rows) {
        if (rows.length > 0) {
            //            debugger;
            result.push({ 'plot_code': ' ', 'is_inzone': ' ', 'zone_id': ' ', 'name': ' ', 'qt': ' ', 'harvester_name': ' ' });
            //   console.log(rows[0]['f_id']);
            // console.log(rows[0]['position']);
            result[0].plot_code = rows[0]['f_id'];
            result[0].is_inzone = rows[0]['position'] > 0 ? true : false;
            result[0].zone_id = rows[0]['zone_id'];
            result[0].name = rows[0]['name'];
            result[0].qt = rows[0]['qt'];
            result[0].harvester_name = rows[0]['harvester_name'];
            callback(result);
            return;
        } else {
            callback(result);
            return;
        }
    });

    //SELECT position((SELECT f_id FROM FID) IN plot_code),plot_code
    //FROM htt5
    //WHERE harvester_number='CH-17'
}


function _is_infactory(blackbox_id_truck, htt_place, lon, lat, xtransectionid, callback)
{
    debugger;
    var result = [];
    var ikey_recnow = { 'column': "htt_place", 'key': blackbox_id_truck, 'val': '' }
    //var status_place = { 'place': ' ' };
    var sql = "(SELECT iarea_name FROM htt3 WHERE ST_Contains(iarea_polygon, ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 )";
    db.get_rows(pg_query, sql, function (rows)
    {
        if (rows.length > 0)
        {
           debugger;
            var place_th = rows[0]['iarea_name'];

            var log_json = { 'blackbox_id': blackbox_id_truck, 'htt_place': htt_place, 'lon': lon, 'lat': lat, 'place': place_th }
            console.log('is_infactory' + JSON.stringify(log_json));

            var place_en = ' ';
            switch (place_th)
            {
              //#region 'ลานนอก'
                case 'ลานนอก': {
                    var step1 = false; var step2 = false;
                    //++++++
                    if (htt_place != 'PARK_OUTSIDE')
                    {
                        place_en = 'PARK_OUTSIDE';
                        var sql_update = "UPDATE rec_now SET htt_park_outside=" + utl.sqote(utcp.now()) + ", htt_place=" + utl.sqote(place_en) + ",htt_factorytime=" + utl.sqote(create_time()) + " WHERE blackbox_id=" + utl.sqote(blackbox_id_truck);

                        dtc2cane.iexcute(pg_realtime, sql_update, function (res_update) {
                            console.log(res_update);
                        });


                        //ส่งระยะทางจากไร่ถึงโรงงาน
                        //* Call Service CANE  harvest_order_distance
             
                        irec_now.get_mile_truck(blackbox_id_truck, function (rows)
                        {
                            //console.log(rows);
                            console.log('is_infactory Call Service CANE  harvest_order_distance '+JSON.stringify(rows));
                            if (rows.length > 0)
                            {
                                //ส่งระยะทางจากไร่ถึงโรงงาน
                                //* Call Service CANE  harvest_order_distance

                                var miles = rows[0]['miles'];
                                var transectionid = rows[0]['htt_transectionid'];
                                var para_order_distance = { 'transectionid': transectionid, 'miles': miles };
                                var truck_name = rows[0]['htt_truck_name'];
                             
                                dtc2cane.set_harvest_order_distance(para_order_distance, function (res)
                                {
                                    console.log('send harvest_order_distance transectionid : ' + transectionid + ' miles : ' + miles+' '+res);
                                   // console.log(res);
                                    if (res != 'oK')
                                    {
                                        irec_now.set_already_send_orderdistance(blackbox_id_truck, 'send', function (r)
                                        {
                                            //  console.log(r);
                                            result.push({ 'place_th': place_th, 'place_en': place_en });

                                            //ส่ง PARK_OUTSIDE to CANE
                                            var cane_para_truck = truck_name + ',' + utcp.now() + ',ENGINE_OFF,PARK_OUTSIDE,';
                                            dtc2cane.set_delivery_vehicle_working_current(cane_para_truck, function (xres2)
                                            {
                                                console.log(' PARK_OUTSIDE to CANE ' + xres2);

                                                //#region
                                              /*
                                                var cane_para_timestap = transectionid + ',' + utcp.now() + ',park_outside_timestamp';
                                                    console.log(cane_para_timestap + ' set_delivery_vehicle_timestamp ');

                                                    dtc2cane.set_delivery_vehicle_timestamp(cane_para_timestap, function (res_timestap)
                                                    {
                                                        if (res_timestap != ' ')
                                                        {
                                                            console.log(cane_para_timestap + ' set_delivery_vehicle_timestamp ' + res_timestap);
                                                            step1 = true;
                                                            fin();
                                                        }
                                                    });
*/
                                                //#endregion

                                                step1 = true;
                                                fin();
                                            });



                                        });
                                    }
                                    else
                                    {
                                        console.log("is_infactory " + res)
                                        step1 = true;
                                        fin();
                                    }

                                  

                                    //else
                                    //{
                                    //    console.log("is_infactory "+res)
                                    //    callback([]);
                                    //    return;
                                    //}

                                });
                            }
                        });

                        //#region
                        //ส่ง เวลา ณ สถานที่ต่าง ๆ ของรถบรรทุก เวลาเข้าลานนอก (boundary โรงงาน?)
                        /*
                        irec_now.get_transectionid(blackbox_id_truck, function (res_transectionid)
                        {
                            if (res_transectionid != 0)
                            {
                                var cane_para_timestap = res_transectionid + ',' + utcp.now() + ',park_outside_timestamp';
                                console.log(cane_para_timestap + ' set_delivery_vehicle_timestamp ');

                                dtc2cane.set_delivery_vehicle_timestamp(cane_para_timestap, function (res_timestap)
                                {
                                    if (res_timestap != ' ')
                                    {
                                        console.log(cane_para_timestap + ' set_delivery_vehicle_timestamp ' + res_timestap);
                                        step2 = true;
                                        fin();
                                    }
                                });

                            }
                        });
*/
                    //#endregion

                        function fin()
                        {
                            if (step1 == true )
                            {
                                console.log('is_infactory fin PARK_OUTSIDE ' + JSON.stringify(result));
                                callback(result);
                                return;
                            }
                        }

                    }
                    else
                    {
                        console.log('is_infactory place ' + place_en);
                        callback([]);
                        return;
                       
                    }

                } break;

            //#endregion
               
              //#region 'ลานเตรียม'
                case 'ลานเตรียม':
                    {
                        var t1 = false; var t2 = false;
                        //if (htt_place != 'PARK_PREPARE' )
                        if(htt_place == 'PARK_OUTSIDE')
                        {
                           
                            var sql_update = "UPDATE rec_now SET htt_park_prepare=" + utl.sqote(utcp.now()) + ", htt_place='PARK_PREPARE'   WHERE blackbox_id=" + utl.sqote(blackbox_id_truck);

                            dtc2cane.iexcute(pg_realtime, sql_update, function (res_update) {
                                console.log(res_update);
                                place_en = 'PARK_PREPARE'; ikey_recnow.val = place_en;
                                result.push({ 'place_th': place_th, 'place_en': place_en });
                                t1 = true;
                                is_finpark_prepare();

                            });

                            //#region
                            //place_en = 'PARK_PREPARE'; ikey_recnow.val = place_en;
                            //irec_now.set_recnow_operate(ikey_recnow, function (x) {
                            //    console.log('set factory ' + place_en + ' ' + x);
                            //    result.push({ 'place_th': place_th, 'place_en': place_en });
                            //    t1 = true;
                            //    is_finpark_prepare();

                            //});

                            //ส่ง เวลา ณ สถานที่ต่าง ๆ ของรถบรรทุก เวลาเข้าลานเตรียม (แจ้งคิว)
                            // irec_now.get_transectionid(blackbox_id_truck, function (res_transectionid) {
                            /*
                                if (xtransectionid != 0)
                                {
                                    var cane_para_timestap = xtransectionid + ',' + utcp.now() + ',park_prepare_timestamp'
                                    dtc2cane.set_delivery_vehicle_timestamp(cane_para_timestap, function (res_timestap)
                                    {
                                        if (res_timestap != ' ')
                                        {
                                            console.log(cane_para_timestap + ' set_delivery_vehicle_timestamp ' + res_timestap);
                                            t2 = true;
                                            is_finpark_prepare();
                                        }

                                    });
                                }*/

                            // });

                            //#endregion

                            function is_finpark_prepare() {
                                if (t1 ==true ){//&& t2== true) {
                                    callback(result);
                                    return;
                                }
                            }
                        }
                        else {
                            console.log('still  ' + htt_place);
                            callback([]);
                            return;
                        }

                    } break;
                    //#endregion

              //#region ลานใน
                case 'ลานใน':
                    {

                    var t1 = false; var t2 = false;
                        // if (htt_place != 'PARK_INSIDE')
                    if(htt_place =='PARK_PREPARE')
                    {
                        //place_en = 'PARK_INSIDE'; ikey_recnow.val = place_en;
                        //irec_now.set_recnow_operate(ikey_recnow, function (x) {
                        //    console.log('set factory ' + place_en + ' ' + x);
                        //    result.push({ 'place_th': place_th, 'place_en': place_en });
                        //    t1 = true;
                        //    is_finpark_inside()
                        //})

                        var sql_update = "UPDATE rec_now SET htt_park_inside=" + utl.sqote(utcp.now()) + ", htt_place='PARK_INSIDE'   WHERE blackbox_id=" + utl.sqote(blackbox_id_truck);

                        dtc2cane.iexcute(pg_realtime, sql_update, function (res_update) {
                            console.log(res_update);
                            place_en = 'PARK_INSIDE'; ikey_recnow.val = place_en;
                            result.push({ 'place_th': place_th, 'place_en': place_en });
                            t1 = true;
                            is_finpark_inside()

                        });

                        //#region
                        //ส่ง เวลา ณ สถานที่ต่าง ๆ ของรถบรรทุก เวลาเข้าลานใน (แจ้งคิว)
                      //  irec_now.get_transectionid(blackbox_id_truck, function (res_transectionid)
                        //  {
                      /*
                            if (xtransectionid != 0)
                            {
                                var cane_para_timestap = xtransectionid + ',' + utcp.now() + ',park_inside_timestamp'
                                dtc2cane.set_delivery_vehicle_timestamp(cane_para_timestap, function (res_timestap)
                                {
                                    if (res_timestap != ' ')
                                    {
                                        console.log(cane_para_timestap + ' set_delivery_vehicle_timestamp ' + res_timestap);
                                        t2 = true;
                                        is_finpark_inside();
                                    }
                                });
                            }
                      */
                       // });

                        //#endregion

                        function is_finpark_inside()
                        {
                            if (t1==true ){ //&& t2==true) {
                                callback(result);
                                return;
                            }
                        }
                    }
                    else {
                        console.log('still  ' + htt_place);
                        callback([]);
                        return;
                    }

                } break;
            }
            //#endregion
          
        }
        else
        {
            //#region ออกจากโซนโรงงาน
            debugger;
            if (htt_place == 'PARK_INSIDE')
            {
                place_en = 'ROAD_WITHOUT_CANE';
                var t1 = false; var t2 = false;
                //ROAD_WITHOUT_CANE
                //clear for  ส่งระยะทางจากไร่ถึงโรงงาน set flag =0
                var sql_clr = "UPDATE rec_now SET htt_factory_leaving=" +utl.sqote( utcp.now()) + ", htt_place='ROAD_WITHOUT_CANE',htt_match_harvester_truck=' ',htt_truck_distance='0', htt_is_send_order_distance='0',htt_status_truck='EMPTY'  WHERE blackbox_id=" + utl.sqote(blackbox_id_truck);
                dtc2cane.iexcute(pg_realtime, sql_clr, function (res_update) {
                    //  console.log(res_update);
                    if (res_update == 'oK')
                    {
                        t1 = true;
                        result.push({ 'place_th': ' ', 'place_en': place_en });
                        is_finleaf_factory();
                      
                    }
                });

                //#region
                //ส่ง เวลา ณ สถานที่ต่าง ๆ ของรถบรรทุก เวลาออกจากลานใน
             //   irec_now.get_transectionid(blackbox_id_truck, function (res_transectionid)
                //    {
            /*
                    if (xtransectionid != 0)
                    {
                        var cane_para_timestap = xtransectionid + ',' + utcp.now() + ',factory_leaving_timestamp'
                        dtc2cane.set_delivery_vehicle_timestamp(cane_para_timestap, function (res_timestap) {
                            if (res_timestap != ' ')
                            {
                                console.log(cane_para_timestap + ' set_delivery_vehicle_timestamp ' + res_timestap);
                                t2 = true;
                                is_finleaf_factory();
                            }
                        });
                    }
               // });
            */
            //#endregion

                function is_finleaf_factory()
                {
                    if (t1 == true ) //&& t2 == true)
                    {
                        console.log('is_infactory fin ROAD_WITHOUT_CANE ' + JSON.stringify(result));
                        callback(result);
                        return;
                    }
                }
            }
            else
            {
                callback(result);
                return;
            }

            //#endregion
        }

    });

}


function is_inpolygon(blackbox_id, lon, lat,callback)
{
    var sql = "SELECT f_id FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 ";
    db.get_rows(pg_query, sql, function (rows) {
        if (rows.length > 0) {
            debugger;
          //  console.log(rows[0]['f_id']);
            callback(rows[0]['f_id']);
            return;
        } else {
            callback([]);
            return;
        }
    });
}


function worknot_inconfigpolygon(lon, lat, callback)
{
    var result = [];
    var sql = "SELECT f_id,zone_id FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 ";
    db.get_rows(pg_query, sql, function (rows) {
        if (rows.length > 0) {
            debugger;
            result.push({ 'plot_code': ' ', 'zone_id': ' '});
            result[0].plot_code = rows[0]['f_id'];
            result[0].zone_id = rows[0]['zone_id'];
            callback(result);
            return;
        } else {
            callback([]);
            return;
        }
    });
}

exports.is_inconfig_polygon = is_inconfig_polygon;
exports.is_inconfig_polygon_buffer = is_inconfig_polygon_buffer;
exports.is_infactory = is_infactory;
exports.is_inpolygon = is_inpolygon;
exports.worknot_inconfigpolygon = worknot_inconfigpolygon;

function test_to_cane(blackbox_id_truck) {
    debugger;
    irec_now.get_transectionid(blackbox_id_truck, function (res_transectionid) {
        if (res_transectionid != 0)
        {
            debugger;
            var cane_para_timestap = res_transectionid + ',' + utcp.now() + ',park_prepare_timestamp'
            dtc2cane.set_delivery_vehicle_timestamp(cane_para_timestap, function (res_timestap) {
                debugger;
                if (res_timestap != ' ') 
                    {
                    console.log(cane_para_timestap + ' set_delivery_vehicle_timestamp ' + res_timestap);
                    // t2 = true;
                    // is_finpark_prepare();
                }

            });
        }
    });
}


//#region
    /*
setTimeout(function () {

    //is_inconfig_polygon(104090169333, 102.195250325693, 16.4149841094033, function (x) { });
    //is_infactory('189600118236', '102.120392098869', '16.4813995320632', function (x) {
    //    debugger;
    //    console.log(x);
    //})
   // (, )
    is_infactory('189600128540', 'park_inside', '102.121', '16.4785', function (x) {
        debugger;
        console.log(x);
    })

  //  test_to_cane('189600116133');

},1000)
*/

//#endregion

//#region  test



function _is_out_zone(f_id, callback) {
    //'105413050'
    var sql = "SELECT position('" + fid + "') IN plot_code) FROM htt5 WHERE harvester_number='CH-17' ";
    db.get_rows(pg_query, sql, function (rows) {
        if (rows.length > 0) {
            debugger;
            console.log(rows[0]['f_id']);
            callback(rows[0]['f_id']);
            return;
        } else {
            callback('out polygon ' + f_id);
            return;
        }
    });
}
    //102.10598832246,16.864367848042

    /*
     

SELECT
	truck.truck_name,
	rec_now.blackbox_id,
	r_lon,
	r_lat,
	r_time,
	r_status,
	r_speed,
	headding,
	tambol,
	amphur,
	province,
htt_status_operation,
htt_status_useability,
htt_status_truck
FROM
	rec_now,
	truck,
	blackbox
WHERE
	blackbox.blackbox_id = rec_now.blackbox_id
AND truck.truck_id = blackbox.truck_id


    SELECT * FROM htt5
WHERE harvester_number='CH-17'
AND plot_code @> '{105755029,105413050,105755029,105809036}'::varchar[];

SELECT '{apple,cherry apple, avocado}'::text[];

SELECT * FROM htt5
WHERE harvester_number='CH-17'
AND plot_code IN ('105413050')

SELECT position('105413050' IN plot_code)
FROM htt5
WHERE harvester_number='CH-17'

SELECT plot_code FROM htt5 WHERE harvester_number='CH-17'

SELECT
array_to_string(array(
--SELECT split_to_rows(criteria,',') 
SELECT split_to_rows(plot_code,',') FROM htt5 WHERE harvester_number='CH-17'
), ''',''') AS id

SELECT
	f_id
FROM
	htt1
WHERE
	ST_Contains (
		wkt_geom,
		ST_SetSRID (
			ST_Point (
				102.10598832246,
				16.864367848042
			),
			4326
		)
	)
LIMIT 1


UPDATE htt5 SET harvester_number='CH-17',plot_code='105755029,105413050,105755029,105809036' WHERE havester_id='1'

     */

    /*
http://stackoverflow.com/questions/15378216/postgresql-contains-in-where-clause
 http://www.linuxtopia.org/online_books/database_guides/Practical_PostgreSQL_database/PostgreSQL_x8973_003.htm#AEN10365
        
SELECT position('105755029' IN plot_code),plot_code
FROM htt5
WHERE harvester_number='CH-17'


SELECT f_id FROM htt1 WHERE	ST_Contains (wkt_geom,ST_SetSRID (ST_Point(102.10598832246,16.864367848042),4326)) LIMIT 1


SELECT position(
	(SELECT	f_id FROM htt1 WHERE ST_Contains (wkt_geom,ST_SetSRID (ST_Point (102.10598832246,16.864367848042),4326)) LIMIT 1)
IN plot_code),plot_code
FROM htt5
WHERE harvester_number='CH-17'

	(SELECT	f_id FROM htt1 WHERE ST_Contains (wkt_geom,ST_SetSRID (ST_Point (102.07555,16.406717),4326)) LIMIT 1)
     */


    //#endregion

    //complete
 //#region
/*
 WITH xID as 
(SELECT f_id  FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(102.195250325693,16.4149841094033), 4326 ) ) LIMIT 1 )

SELECT position((SELECT f_id FROM xID) IN 
	(SELECT array_to_string(array(	SELECT dh.plot_code FROM  detail_havester as dh ,htt1 WHERE dh.havest_vehicle_code='K003746' AND dh.plot_code =htt1.f_id), ',') AS f_id)
)
--,(SELECT array_to_string(array(	SELECT dh.plot_code FROM  detail_havester as dh ,htt1 WHERE dh.havest_vehicle_code='K003746' AND dh.plot_code =htt1.f_id), ',') AS f_id)
 FROM xID
 */
//#endregion

//#region query test
/*
 WITH xID AS (
	SELECT
		f_id
	FROM
		htt1
	WHERE
		ST_Contains (
			wkt_geom,
			ST_SetSRID (
				ST_Point (
					102.195250325693,
					16.4149841094033
				),
				4326
			)
		)
	LIMIT 1
) SELECT
	POSITION (
		(SELECT f_id FROM xID) IN (
			SELECT
				array_to_string(
					ARRAY (
						SELECT
							dh.plot_code
						FROM
							detail_havester AS dh,
							htt1
						WHERE
							dh.havest_vehicle_code = get_harvester ('104090169333')
						AND dh.plot_code = htt1.f_id
					),
					','
				) AS f_id
		)
	),
	(SELECT f_id FROM xID)
	,(SELECT zone_id FROM htt1 WHERE f_id=(SELECT f_id FROM xID))
FROM
	xID
 */
    //#endregion


