
//#region modules
var mustache = require("mustache");
var moment = require('moment');

var utcp = require('Utility_tcp.js');
var utl = require('Utility.js');
var db = require('iConnectdb_ktc.js');
var iconn = require('conn_sugar_cane.js');

var pg_query = new db.im2(iconn.get_dbconfig_htt());
var pg_htt = new db.im2(iconn.get_dbconfig_htt());
var pg_realtime = new db.im2(iconn.get_dbconfig_realtime());
    //var utcp = require('Utility_tcp.js');
var linq = require('linq.js');

var irec_now = require('htt_master_realtime.js');

//var dtc2cane = require('dtc2cane.js');
//var time_now = moment().format('YYYY-MM-DD HH:mm:ss');

var time_now = {
    now: function () { return moment().format('YYYY-MM-DD HH:mm:ss'); }
};


function create_time() {
    return time_now.now();
}

//#endregion



function is_inconfig_polygon(blackbox_id, lon, lat,callback)
{
    //102.33523,13.7061088

    /*
     SELECT stid,harvester_number,zone
,project_y
,farmerid,pre_name||f_name||' '||l_name as farmer_name
,responsibl
,project_ce,project_cn,project_sd,soil_name,area,area_gread
 FROM sugarcane_farm WHERE ST_Contains(coordinates, ST_SetSRID( ST_Point(102.33523, 13.7061088), 4326 ) )
 LIMIT 1 
     */

    var result = [];
    //ST_Buffer_Meters(wkt_geom, 20)


 
    var sql = "  WITH xID as "
    sql += " (SELECT stid as xstid,que,field_id as f_id,harvester_number,zone as zone_id,project_y "
    sql += ",farmerid,pre_name||f_name||' '||l_name as farmer_name "
    sql += ",responsibl,project_ce,project_cn,project_sd,soil_name,area,area_gread "
    sql += " FROM sugarcane_farm WHERE ST_Contains(coordinates, ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 ) "
    sql += " SELECT (SELECT COUNT(stid) FROM sugarcane_farm WHERE harvester_number=harvester_number AND stid=xstid ) as is_inzone "
    sql += " ,* FROM xID "

    debugger;
    /**/
     db.get_rows(pg_query, sql, function (rows)
     {
        // console.log('do this inout_polygon ' + rows.length);
        if (rows.length > 0)
        {
            debugger;
            result.push({ 'plot_code': ' ', 'is_inzone': ' ', 'zone_id': ' ', 'name': ' ', 'que': ' ', 'harvester_name': ' ' });
            result[0].plot_code = rows[0]['f_id'];
            result[0].is_inzone = rows[0]['is_inzone'] > 0 ? true : false;
            result[0].zone_id = rows[0]['zone_id'];
            result[0].name = rows[0]['farmer_name'];
            result[0].que = rows[0]['que'];
            result[0].harvester_name = rows[0]['harvester_number'];
            callback(result);
            return;
        } else {
            callback(result);
            return;
        }
    });

    //callback(result);
    //return;
//SELECT position((SELECT f_id FROM FID) IN plot_code),plot_code
//FROM htt5
//WHERE harvester_number='CH-17'
}


function is_inconfig_polygon_buffer(blackbox_id, lon, lat,buffer, callback) {

    /*
     SELECT stid as xstid,que,field_id as f_id
,split_part(harvester_number, ',', 1) as harvester1
,split_part(harvester_number, ',', 2) as harvester2
,zone as zone_id
 FROM sugarcane_farm 
  WHERE ST_Contains(ST_BUFFER(coordinates::geography,20)::geometry
, ST_SetSRID( ST_Point(102.33523,13.7061088), 4326 ) ) LIMIT 1 
     */
    //102.33523,13.7061088
    //ST_BUFFER(wkt_geom::geography,20)::geometry
    var result = [];
    //ST_Buffer_Meters(wkt_geom, 20)


    var sql = " SELECT stid as xstid,que,field_id as f_id ";
    sql += ",split_part(harvester_number, ',', 1) as harvester1 ";
    sql += ",split_part(harvester_number, ',', 2) as harvester2 ";
    sql += ",zone as zone_id,que ";
  //  sql += ", get_harvester(" + utl.sqote(blackbox_id) + ") as harvester_name ";
    sql += ", "+blackbox_id+" as harvester_name ";
    sql += " FROM sugarcane_farm  ";
    sql += " WHERE ST_Contains(ST_BUFFER(coordinates::geography,"+buffer+")::geometry ";
    sql += ", ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 ";

   // debugger;
    db.get_rows(pg_query, sql, function (rows) {
        if (rows.length > 0) {
            //            debugger;
            result.push({ 'plot_code': ' ', 'is_workout_zone': ' ', 'zone_id': ' ', 'name': ' ', 'que': ' ', 'harvester_name': ' ' });
          
            var harvester1 = rows[0]['harvester1'];
            var harvester2 = rows[0]['harvester2'];
            var is_workout_zone =false;
            is_workout_zone = harvester1 != rows[0]['harvester_name'] ? true : false;
            is_workout_zone = harvester2 != rows[0]['harvester_name'] ? true : false;

            result[0].plot_code = rows[0]['f_id'];
            result[0].is_workout_zone = is_workout_zone;
            result[0].zone_id = rows[0]['zone_id'];
          //  result[0].name = rows[0]['name'];
            result[0].que = rows[0]['que'];
            result[0].harvester_name = rows[0]['harvester_name'];
            callback(result);
            return;
        } else {
            callback(result);
            return;
        }
    });

    //SELECT position((SELECT f_id FROM FID) IN plot_code),plot_code
    //FROM htt5
    //WHERE harvester_number='CH-17'
}




function is_inpolygon(blackbox_id, lon, lat,callback)
{
    var sql = "SELECT f_id FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 ";
    db.get_rows(pg_query, sql, function (rows) {
        if (rows.length > 0) {
            debugger;
          //  console.log(rows[0]['f_id']);
            callback(rows[0]['f_id']);
            return;
        } else {
            callback([]);
            return;
        }
    });
}


function worknot_inconfigpolygon(lon, lat, callback)
{
    var result = [];
    var sql = "SELECT f_id,zone_id FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 ) ) LIMIT 1 ";
    db.get_rows(pg_query, sql, function (rows) {
        if (rows.length > 0) {
            debugger;
            result.push({ 'plot_code': ' ', 'zone_id': ' '});
            result[0].plot_code = rows[0]['f_id'];
            result[0].zone_id = rows[0]['zone_id'];
            callback(result);
            return;
        } else {
            callback([]);
            return;
        }
    });
}

exports.is_inconfig_polygon = is_inconfig_polygon;
exports.is_inconfig_polygon_buffer = is_inconfig_polygon_buffer;
exports.is_inpolygon = is_inpolygon;
exports.worknot_inconfigpolygon = worknot_inconfigpolygon;

function test_to_cane(blackbox_id_truck) {
    debugger;
    irec_now.get_transectionid(blackbox_id_truck, function (res_transectionid) {
        if (res_transectionid != 0)
        {
            debugger;
            var cane_para_timestap = res_transectionid + ',' + utcp.now() + ',park_prepare_timestamp'
            dtc2cane.set_delivery_vehicle_timestamp(cane_para_timestap, function (res_timestap) {
                debugger;
                if (res_timestap != ' ') 
                    {
                    console.log(cane_para_timestap + ' set_delivery_vehicle_timestamp ' + res_timestap);
                    // t2 = true;
                    // is_finpark_prepare();
                }

            });
        }
    });
}


//#region
    /*
setTimeout(function () {

    //13.723464,102.498901

    is_inconfig_polygon(1010003010, 102.497947, 13.723552, function (x) { console.log(x); });
    //is_infactory('189600118236', '102.120392098869', '16.4813995320632', function (x) {
    //    debugger;
    //    console.log(x);
    //})
   // (, )
    //is_infactory('189600128540', 'park_inside', '102.121', '16.4785', function (x) {
    //    debugger;
    //    console.log(x);
    //})

  //  test_to_cane('189600116133');

    //is_inconfig_polygon_buffer('8', 102.370085460477, 13.7870896379905,20, function (xres) {

    //});

},1000)
*/

//#endregion

//#region  test



function _is_out_zone(f_id, callback) {
    //'105413050'
    var sql = "SELECT position('" + fid + "') IN plot_code) FROM htt5 WHERE harvester_number='CH-17' ";
    db.get_rows(pg_query, sql, function (rows) {
        if (rows.length > 0) {
            debugger;
            console.log(rows[0]['f_id']);
            callback(rows[0]['f_id']);
            return;
        } else {
            callback('out polygon ' + f_id);
            return;
        }
    });
}
    //102.10598832246,16.864367848042

    /*
     

SELECT
	truck.truck_name,
	rec_now.blackbox_id,
	r_lon,
	r_lat,
	r_time,
	r_status,
	r_speed,
	headding,
	tambol,
	amphur,
	province,
htt_status_operation,
htt_status_useability,
htt_status_truck
FROM
	rec_now,
	truck,
	blackbox
WHERE
	blackbox.blackbox_id = rec_now.blackbox_id
AND truck.truck_id = blackbox.truck_id


    SELECT * FROM htt5
WHERE harvester_number='CH-17'
AND plot_code @> '{105755029,105413050,105755029,105809036}'::varchar[];

SELECT '{apple,cherry apple, avocado}'::text[];

SELECT * FROM htt5
WHERE harvester_number='CH-17'
AND plot_code IN ('105413050')

SELECT position('105413050' IN plot_code)
FROM htt5
WHERE harvester_number='CH-17'

SELECT plot_code FROM htt5 WHERE harvester_number='CH-17'

SELECT
array_to_string(array(
--SELECT split_to_rows(criteria,',') 
SELECT split_to_rows(plot_code,',') FROM htt5 WHERE harvester_number='CH-17'
), ''',''') AS id

SELECT
	f_id
FROM
	htt1
WHERE
	ST_Contains (
		wkt_geom,
		ST_SetSRID (
			ST_Point (
				102.10598832246,
				16.864367848042
			),
			4326
		)
	)
LIMIT 1


UPDATE htt5 SET harvester_number='CH-17',plot_code='105755029,105413050,105755029,105809036' WHERE havester_id='1'

     */

    /*
http://stackoverflow.com/questions/15378216/postgresql-contains-in-where-clause
 http://www.linuxtopia.org/online_books/database_guides/Practical_PostgreSQL_database/PostgreSQL_x8973_003.htm#AEN10365
        
SELECT position('105755029' IN plot_code),plot_code
FROM htt5
WHERE harvester_number='CH-17'


SELECT f_id FROM htt1 WHERE	ST_Contains (wkt_geom,ST_SetSRID (ST_Point(102.10598832246,16.864367848042),4326)) LIMIT 1


SELECT position(
	(SELECT	f_id FROM htt1 WHERE ST_Contains (wkt_geom,ST_SetSRID (ST_Point (102.10598832246,16.864367848042),4326)) LIMIT 1)
IN plot_code),plot_code
FROM htt5
WHERE harvester_number='CH-17'

	(SELECT	f_id FROM htt1 WHERE ST_Contains (wkt_geom,ST_SetSRID (ST_Point (102.07555,16.406717),4326)) LIMIT 1)
     */


    //#endregion

    //complete
 //#region
/*
 WITH xID as 
(SELECT f_id  FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(102.195250325693,16.4149841094033), 4326 ) ) LIMIT 1 )

SELECT position((SELECT f_id FROM xID) IN 
	(SELECT array_to_string(array(	SELECT dh.plot_code FROM  detail_havester as dh ,htt1 WHERE dh.havest_vehicle_code='K003746' AND dh.plot_code =htt1.f_id), ',') AS f_id)
)
--,(SELECT array_to_string(array(	SELECT dh.plot_code FROM  detail_havester as dh ,htt1 WHERE dh.havest_vehicle_code='K003746' AND dh.plot_code =htt1.f_id), ',') AS f_id)
 FROM xID
 */
//#endregion

//#region query test
    /*
    
    SELECT stid,harvester_number,zone
,project_y
,farmerid,pre_name||f_name||' '||l_name as farmer_name
,responsibl
,project_ce,project_cn,project_sd,soil_name,area,area_gread
--, get_harvester(" + utl.sqote(blackbox_id) + ") as harvester_name
 FROM sugarcane_farm WHERE ST_Contains(coordinates, ST_SetSRID( ST_Point(102.33523, 13.7061088), 4326 ) )
 LIMIT 1 

 WITH xID AS (
	SELECT
		f_id
	FROM
		htt1
	WHERE
		ST_Contains (
			wkt_geom,
			ST_SetSRID (
				ST_Point (
					102.195250325693,
					16.4149841094033
				),
				4326
			)
		)
	LIMIT 1
) SELECT
	POSITION (
		(SELECT f_id FROM xID) IN (
			SELECT
				array_to_string(
					ARRAY (
						SELECT
							dh.plot_code
						FROM
							detail_havester AS dh,
							htt1
						WHERE
							dh.havest_vehicle_code = get_harvester ('104090169333')
						AND dh.plot_code = htt1.f_id
					),
					','
				) AS f_id
		)
	),
	(SELECT f_id FROM xID)
	,(SELECT zone_id FROM htt1 WHERE f_id=(SELECT f_id FROM xID))
FROM
	xID
 */
    //#endregion


