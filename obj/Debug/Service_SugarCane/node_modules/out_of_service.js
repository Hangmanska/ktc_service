
    //#region modules
var iconn = require('conn_sugar_cane.js');
var db = require('iConnectdb_ktc.js');
var utl = require('Utility.js');
var utcp = require('Utility_tcp.js');
var iRep = require('iReport.js');
var inout = require('harvester_in_out_farm.js');
var ktc2cane = require('ktc2cane.js');

var dblink = 'dbname=dbu_101279 port=5432';
var status_name = "out_of_service";

var pg_htt = new db.im2(iconn.get_dbconfig_htt());
var pg_realtime = new db.im2(iconn.get_dbconfig_realtime());

var zone_data = { 'plot_code': ' ', 'zone_id': ' ' };

    //#endregion

    //'88' รถตัด : '99' รถบรรทุก;

//step start report from insert_vehicle_lost //service_htt.js
function start_out_of_service(vehicle_name, vehicle_type, start_lost,end_lost,id_lost,callback)
{
    // var r_status = vehicle_type == "รถตัด" ? '88'  : '99';
   // var r_status='88';
    var condition = ' ';
    var s1 = "blackbox_id,r_lon,r_lat,tambol,amphur,province";
    debugger;
    switch (vehicle_type)
    {
        case "รถตัด": {
          
            harvester_vehicle_working_logsend2cane(vehicle_name, start_lost, end_lost, function (xrs)
            {
                r_status = '88'; condition = ' get_blackbox_id(' + utl.sqote(vehicle_name) + ');'

                var sql = "SELECT " + s1 + " FROM "
                sql += " dblink(" + utl.sqote(dblink) + ", 'SELECT " + s1 + " FROM rec_now')as rec_now (blackbox_id varchar(25),r_lon varchar(20),r_lat varchar(20),tambol varchar(255),amphur varchar(255),province varchar(255)) ";
                sql += " WHERE blackbox_id=" + condition;
                //utl.sqote(blackbox_id);
                //sql += " WHERE blackbox_id=get_blackbox_id(" + utl.sqote(vehicle_name) + ") ";

                db.get_rows(pg_htt, sql, function (res) {

                    if (res.length > 0) {
                        var r = res[0];
                        var start =
                        {
                            'blackbox_id': r.blackbox_id, 'r_time': start_lost, 'r_status': r_status, 'vehicle_type': vehicle_type
                         , 'tambol': r.tambol, 'amphur': r.amphur, 'province': r.province, 'lat': r.r_lat, 'lon': r.r_lon
                         , 'id': ' ', 'total_time': ' ', 'id_lost': id_lost
                        }


                        iRep.check_history_status_havester(start, zone_data, function (res) {
                            debugger;
                            //  console.log(res);
                            set_recnow_outofservice(start, function (result_callback) {
                                callback(result_callback);
                                return;
                            });
                        });
                        //           console.log(start);
                    }

                });

            });

        } break;
          
        default: {   //รถบรรทุก
           
            delivery_vehicle_working_logsend2cane(vehicle_name, start_lost, end_lost, function (xress)
            {
                r_status = '99'; condition = ' get_blackbox_truck(' + utl.sqote(vehicle_name) + ');'

                var sql = "SELECT " + s1 + " FROM "
                sql += " dblink(" + utl.sqote(dblink) + ", 'SELECT " + s1 + " FROM rec_now')as rec_now (blackbox_id varchar(25),r_lon varchar(20),r_lat varchar(20),tambol varchar(255),amphur varchar(255),province varchar(255)) ";
                sql += " WHERE blackbox_id=" + condition;
                //utl.sqote(blackbox_id);
                //sql += " WHERE blackbox_id=get_blackbox_id(" + utl.sqote(vehicle_name) + ") ";

                db.get_rows(pg_htt, sql, function (res) {

                    if (res.length > 0) {
                        var r = res[0];
                        var start =
                        {
                            'blackbox_id': r.blackbox_id, 'r_time': start_lost, 'r_status': r_status, 'vehicle_type': vehicle_type
                         , 'tambol': r.tambol, 'amphur': r.amphur, 'province': r.province, 'lat': r.r_lat, 'lon': r.r_lon
                         , 'id': ' ', 'total_time': ' ', 'id_lost': id_lost
                        }


                        iRep.check_history_status_havester(start, zone_data, function (res) {
                            debugger;
                            //  console.log(res);
                            set_recnow_outofservice(start, function (result_callback) {
                                callback(result_callback);
                                return;
                            });
                        });
                        //           console.log(start);
                    }

                });
            });

        } break;
       
    }



}

function delivery_vehicle_working_logsend2cane(vehicle_name, start_lost, end_lost, callback)
{
    //set_delivery_vehicle_working_log
    var xdata = vehicle_name+','+start_lost + ','+end_lost + ",OUT_OF_SERVICE,";
    ktc2cane.set_delivery_vehicle_working_log(xdata, function (xres)
    {
        console.log('OUT_OF_SERVICE send2cane_truck_vehicle_working_log ' + xres);
        callback(xres);
        return;
    
    });
}

function harvester_vehicle_working_logsend2cane(vehicle_name, start_lost, end_lost, callback) {
    //set_delivery_vehicle_working_log
    var xdata = vehicle_name + ',' + start_lost + ',' + end_lost + ",OUT_OF_SERVICE";
    ktc2cane.set_harvest_vehicle_working_log(xdata, function (xres) {
        console.log('OUT_OF_SERVICE harvester_vehicle_working_logsend2cane ' + xres);
        callback(xres);
        return;

    });
}

//step end report from rec_now 
function end_out_of_service(blackbox_id, vehicle_type, end_lost)
{
    var r_status = vehicle_type == "รถตัด" ? '88' : '99';
    //var r_status = '88';
    //var condition = ' ';
    //switch (vehicle_type) {
    //    case "รถตัด": { r_status = '88'; condition = ' get_blackbox_id(' + utl.sqote(vehicle_name) + ');' } break;
    //    default: { r_status = '99'; condition = ' get_blackbox_truck(' + utl.sqote(vehicle_name) + ');' } break;
    //}
    var s1 = "blackbox_id,r_lon,r_lat,tambol,amphur,province";
    var sql = "SELECT " + s1 + " FROM "
    sql += " dblink(" + utl.sqote(dblink) + ", 'SELECT " + s1 + " FROM rec_now')as rec_now (blackbox_id varchar(25),r_lon varchar(20),r_lat varchar(20),tambol varchar(50),amphur varchar(50),province varchar(50)) ";
    sql += " WHERE blackbox_id=" + utl.sqote(blackbox_id);
    // sql += " WHERE blackbox_id=get_blackbox_id(" + utl.sqote(vehicle_name) + ") ";

    db.get_rows(pg_htt, sql, function (res) {

        if (res.length > 0)
        {
            var r = res[0];
            var end =
            {
                'blackbox_id': r.blackbox_id, 'r_time': utcp.now(), 'r_status': r_status, 'vehicle_type': vehicle_type
             , 'tambol': r.tambol, 'amphur': r.amphur, 'province': r.province, 'lat': r.r_lat, 'lon': r.r_lon
             , 'id': ' ', 'total_time': ' '
            }

            iRep.check_history_status_havester(end, zone_data, function (res) {
                debugger;
                console.log(res);
            });
            //           console.log(start);
        }

    });

}



    //if htt_status_useability='out_of_service' 
    //(รถตัด (สายพานลำเลียงหมุน + อยู่ในไร่)) + (รถบรรทุก อยู่ภายใน 15 เมตร)
    //101.99815 16.520133

    //htt_master_recnow.js
function set_havester_ready(result,callback)
{

       if (result.blackbox_id != 0 && result.plot_code != 0)
        {
            set_recnow_outofservice(result.blackbox_id, 'ready', null, function (xres)
            {
                end_out_of_service(result.blackbox_id, 'รถตัด', result.r_time);
                set_end_time_lost_vehicle(result.r_time, result.htt_id_lost, function (res) {
                    callback(res);
                    return;
                });
            });

        }


    function set_end_time_lost_vehicle(start_time_ready, id_lost,callback)
    {
        var sql = " UPDATE lost_vehicle SET end_lost=" + utl.sqote(start_time_ready) + " WHERE id=" + utl.sqote(id_lost);
        db.excute(pg_htt, sql, function (res) {
            //callback(res);
            //return;
            console.log(' set_endtime ready ' + res);
            callback(res);
            return;
        });
    }

    /*
    SELECT 
    ST_DWithin(
     ST_SetSRID( ST_Point(101.884,16.0239), 4326 )::geography --AS havester
		,ST_SetSRID( ST_Point(101.884,16.0238), 4326 )::geography --AS truck
, 15) 
,(SELECT f_id  FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(101.884,16.0239), 4326 ) ) LIMIT 1 )
    */

}

function set_truck_ready(result, callback)
{


    if (result.blackbox_id != 0 && result.plot_code != 0)
    {
        set_recnow_outofservice(result.blackbox_id, 'ready', null, function (xres)
        {

            end_out_of_service(result.blackbox_id, 'รถบรรทุก', result.r_time);
            set_end_time_lost_vehicle(result.r_time, result.htt_id_lost, function (res) {
                callback(res);
                return;
            });
        });

    
    }


    function set_end_time_lost_vehicle(start_time_ready, id_lost, callback)
    {
        var sql = " UPDATE lost_vehicle SET end_lost=" + utl.sqote(start_time_ready) + " WHERE id=" + utl.sqote(id_lost);
        db.excute(pg_htt, sql, function (res) {
            //callback(res);
            //return;
            console.log(' set_endtime ready ' + res);
            callback(res);
            return;
        });
    }



}

    //set rec_now
function set_recnow_outofservice(data, callback)
{
    var sql = ' ';
    //r.blackbox_id, status_name, id_lost,vehicle_type
    if (data.id_lost != null) {
        sql = "UPDATE rec_now SET htt_status_useability='out_of_service',htt_id_lost=" + utl.sqote(data.id_lost) + " WHERE blackbox_id =" + utl.sqote(data.blackbox_id);
        //OUT_OF_SERVICE
    }
    else {
        sql = "UPDATE rec_now SET htt_status_useability='out_of_service' WHERE blackbox_id =" + utl.sqote(data.blackbox_id);
    }

    if (data.r_status == '88')//รถตัด
    {
       
        ktc2cane.get_harvester_code(data.blackbox_id, function (harvester_code)
        {
            var xres = harvester_code+','+data.r_time + ',' + "OUT_OF_SERVICE";
            ktc2cane.set_harvest_vehicle_working_current(xres, function (tres) {

                console.log('Send Out_of_Service to CANE' + tres);

                db.excute(pg_realtime, sql, function (res) {
                    console.log(' set_recnow_outofservice ' + res);
                    callback(res);
                    return;
                });
            });
        });
      
    }
    if (data.r_status == '99')//รถบรรทุก
    {
        //   //@delivery_vehicle_code varchar(10),@start_time varchar(21),@type varchar(50),@place varchar(50),@loading_harvest_vehicle_code varchar(50)
        ktc2cane.get_truck_code(data.blackbox_id, function (truck_code)
        {
            var xres = truck_code + ',' + data.r_time + ',' + "OUT_OF_SERVICE,,";
            ktc2cane.set_delivery_vehicle_working_current(xres, function (tres)
            {

                console.log('Send Out_of_Service to CANE' + tres);

                db.excute(pg_realtime, sql, function (res)
                {
                    console.log(' set_recnow_outofservice ' + res);
                    callback(res);
                    return;
                });
            });
        });
        
    }

 
}


function set_havester_or_truck(blackbox_id,vehicle_type,callback)
{
   // vehicle_type = vehicle_type == "harvester" ? "0" : "1";
    if (vehicle_type == "harvester")
    {
        ktc2cane.get_harvester_code(blackbox_id, function (harvester_code)
        {
            var sql = "UPDATE rec_now SET htt_harvester_name=" + utl.sqote(harvester_code) + ",htt_harvester_or_truck='0' WHERE blackbox_id =" + utl.sqote(blackbox_id);

            db.excute(pg_realtime, sql, function (res) {
                console.log(' set_havester_or_truck ' + res);
                callback(res);
                return;
            });

        });
    }

    if (vehicle_type == "truck")
    {
        ktc2cane.get_truck_code(blackbox_id, function (truck_code)
        {
            var sql = "UPDATE rec_now SET htt_truck_name=" + utl.sqote(truck_code) + ",htt_harvester_or_truck='1' WHERE blackbox_id =" + utl.sqote(blackbox_id);

            db.excute(pg_realtime, sql, function (res) {
                console.log(' set_havester_or_truck ' + res);
                callback(res);
                return;
            });

        });
    }
 
}



exports.set_havester_or_truck = set_havester_or_truck
exports.start_out_of_service = start_out_of_service;
exports.set_havester_ready = set_havester_ready;
exports.set_truck_ready = set_truck_ready;



    //#region 
    /*
     SELECT
        blackbox_id,
        r_lon,
        r_lat,
        idate (r_time) AS r_time,
        htt_id_lost
    ,htt_havester
    FROM
        rec_now
    WHERE
        ST_DWithin (
            ST_SetSRID (
                ST_Point (100.63874, 13.667367),
                4326
            ) :: geography,
            ST_SetSRID (ST_Point(r_lon, r_lat), 4326) :: geography,
            15
        )
    AND htt_havester = '1'
    LIMIT 1
     */

    //#endregion

    //#region test
    /* 
    setTimeout(function ()
    {
        //lon = 102.195250325693;//lat=16.4149841094033;  // latlon in farm with this blackbox
       // 101.99815, 16.520133  lat lon not in
       //  start_out_of_service('K003746', 'รถตัด', '2015-10-07 07:05:00','4');
        //start_out_of_service('189600110834', 'รถบรรทุก', '2015-10-07 07:05:00', '4', function (re) {
    
        //});
    
       //  is_infarm(102.195250325693,16.4149841094033);
        //  is_havester_ready('104090169333','100.63874' , '13.667367', 15);
        // set_havester_or_truck('189600128641','truck',function(x){console.log(x)})
        debugger;
        start_out_of_service('K004919', 'รถตัด', '2016-03-21 07:00:00','2016-03-21 10:15:00', '54', function () {

        });
       
    }, 1000)
   */
    //#endregion

    //#region
    /*
     WITH xID as 
    (SELECT f_id  FROM htt1 WHERE ST_Contains(wkt_geom, ST_SetSRID( ST_Point(101.884,16.0239), 4326 ) ) LIMIT 1 )
    
    SELECT 
        position( (SELECT f_id FROM xID) IN (SELECT array_to_string(array(	SELECT dh.plot_code FROM  detail_havester as dh ,htt1 WHERE dh.havest_vehicle_code='K003746' AND dh.plot_code =htt1.f_id), ',') AS f_id))
    ,(SELECT f_id  FROM xID) 
     FROM xID
    
    
    
    SELECT
        ST_Distance (truck,havester) --/ 1000 AS dist_km
    , ST_DWithin(truck,havester, 15) as meter
    FROM
        (	SELECT
            ST_SetSRID( ST_Point(101.884,16.0239), 4326 )::geography AS truck
        , ST_SetSRID( ST_Point(101.884,16.0238), 4326 )::geography AS havester
        ) AS foo;
    
    
    
    SELECT
        ST_Distance (truck,havester) --/ 1000 AS dist_km
    , ST_DWithin(truck,havester, 110) as meter  
    FROM
        (	SELECT
            ST_SetSRID( ST_Point(101.884,16.0239), 4326 )::geography AS truck
        , ST_SetSRID( ST_Point(101.885,16.0237), 4326 )::geography AS havester
        ) AS foo;
    
    
    
    SELECT 
            ST_DWithin(
             ST_SetSRID( ST_Point(101.884,16.0239), 4326 )::geography
            ,ST_SetSRID( ST_Point(101.884,16.0238), 4326 )::geography
    , 15) 
     */
    //#endregion