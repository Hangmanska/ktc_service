
//#region modules
var db = require('iConnectdb_ktc.js');
var pg_htt = new db.im2(db.get_dbconfig_htt());
var pg_realtime = new db.im2(db.get_dbconfig_realtime());

var moment = require('moment');
var async = require('async');
var squel = require("squel");
//#endregion

//#region sample query
/*
 WITH CTE AS (
	SELECT
		ROW_NUMBER () OVER (ORDER BY r_time) AS ID,
		SUBSTRING (r_io :: VARCHAR FROM 1 FOR 2) AS r_io,
		DENSE_RANK () OVER (ORDER BY SUBSTRING (r_io :: VARCHAR FROM 1 FOR 2)) AS rnk,
		to_char(r_time,'YYYY-MM-DD HH24:MI:SS') AS r_time
		,r_lon,r_lat
	FROM z189600101733data
	WHERE r_time >= '2015-11-11 00:00:00' AND r_time <= '2015-11-11 23:59:59'
	AND SUBSTRING (r_io :: VARCHAR FROM 1 FOR 2) IN ('10', '11') ORDER BY r_time ASC
) 
SELECT	ID,r_time,r_io,r_lon,r_lat
FROM	cte WHERE rnk = '2'
 */
//#endregion

function get_data(blackbox_id,start_time,end_time,callback)
{
    var sql=" ";
    sql+=" With CTE AS ( ";
    sql+="  SELECT ROW_NUMBER() over (order by r_time) as id ";
    sql+=" ,substring(r_io::varchar from 1 for 2)as r_io ";
    sql += " ,dense_rank() OVER (ORDER BY substring(r_io::varchar from 1 for 2) ) AS rnk ";
    sql += ",to_char(r_time, 'YYYY-MM-DD HH24:MI:SS')as r_time,r_lon,r_lat ";
    sql += " FROM z" + blackbox_id + "data ";
    sql+=" WHERE r_time >= '"+start_time+"' AND r_time <='"+end_time+"' ";
    sql+=" AND substring(r_io::varchar from 1 for 2) IN('10','11') ";	
    sql+=" ORDER BY r_time ASC  ) ";
    sql += " SELECT id,r_time,r_lon,r_lat FROM cte WHERE rnk='2' ";

    db.get_rows(pg_realtime, sql, function (res)
    {
        callback(res);
        return;
    });
}

function struct_data()
{
    this.start = "";
    this.stop = "";
    this.lon_start = "";
    this.lat_start = "";
    this.lon_end = "";
    this.lat_end = "";
}

setTimeout(function ()
{
   // var t ='2015-11-24T14:29:15+08:00'
   // var tt= moment(t).format("YYYY-MM-DD hh:mm:ss");
    debugger;

    var date_now = moment().format("YYYY-MM-DD");
 
    var result = [];
   // var t = { 'start': ' ', 'stop': ' ' };
    var t = new struct_data();
    var i = 0;
    var j = 1;
    var is_true = true;
    var is_finish = false;
    var blackbox_id = "189600101733";
    var start_time = "2015-11-11 00:00:00";
    var end_time = "2015-11-11 23:59:59";

    get_data(blackbox_id,start_time,end_time,function (data)
    {
        //for (var i = 0; i < data.length; i++)
        //{
       // debugger;
        var final = data.length - 1;
        while (i <= data.length && is_finish !=true)
        {
            if (i == 0) {
                t.start = data[i].r_time
                t.lon_start = data[i].r_lon;
                t.lat_start = data[i].r_lat;
            };

            var current = parseInt(data[i].id);

            if (i == final)
            {
                debugger;
                t.stop = data[final].r_time;
                result.push(t);

                console.log('xfin');
                console.log(JSON.stringify(result));
                is_finish = true;

            }
            else
            {
                // if (typeof v === 'undefined') {
                var v = data[j].id;
                if (typeof v === 'undefined')
                {
                    //debugger;
                    console.log('xfin');
                }
                else
                {
                    var next = parseInt(data[j].id);
                }
            }
     
         

            var res = (next - current);
            if (res == 1)
            {
                i++;
                j++;
            }
            else
            {
                if (is_finish==false)
                {
                    t.stop = data[i].r_time;
                    t.lon_end = data[j].r_lon;
                    t.lat_end = data[j].r_lat;
                    result.push(t);

                    t = new struct_data();
                    t.start = data[j].r_time;
       
                    i = j;
                    j++;
                }
            }
        }

    });




}, 1000);