


var db = require('iConnectdb.js');
var pg_htt = new db.im2(db.get_dbconfig_htt());
var utl = require('Utility.js');
var dtc2cane = require('dtc2cane.js');

function get_register(transaction_id,callback) {
   // var sql = " SELECT data_text,transaction_id FROM save_ho_log WHERE response_from_cane =' '";
    var sql = "SELECT data_text,response_from_cane,transaction_id,idate(date_create)as date_create,(resend_count+1) as resend_count FROM save_ho_log WHERE transaction_id= " + utl.sqote(transaction_id);

    db.get_rows(pg_htt, sql, function (res) {
        debugger;
        // console.log(res);
        if (res.length > 0)
        {
            callback(res);
            return;
        }
        else {
            callback([]);
            return;
        }
    });
}

function resend_cut2crush(transaction_id,callback) {
   // var transaction_id = '20151201222643070';
    var step1 = false; var step2 = false;
    if (transaction_id != ' ')
    {
        get_register(transaction_id, function (data_json) {
            debugger;
            if (data_json.length > 0) {
                debugger;


                var data_text = data_json[0]['data_text'];//JSON.parse(data_json[0]['data_text']);
                var response_from_cane = data_json[0]['response_from_cane']; //JSON.parse(data_json[0]['response_from_cane']);
                var date_create = data_json[0]['date_create'];

                dtc2cane.ReSend_save_log_ho(data_text, response_from_cane, date_create, transaction_id, function (res1) {
                    debugger;
                    if (res1 != ' ') {
                        console.log(res1);
                        step1 = true;

                        final();
                    }
                });

                dtc2cane.ReSend_saveHO(data_json, function (res2) {
                    if (res2 != ' ') {
                        step2 = true;
                        final();
                    }
                });



                function final() {
                    if (step1 == true && step2 == true) {

                        var resend_count = data_json[0]['resend_count'];
                        var sql_update = "UPDATE save_ho_log SET resend_count=" + utl.sqote(resend_count) + " WHERE transaction_id=" + utl.sqote(transaction_id);
                        dtc2cane.iexcute(pg_htt, sql_update, function (resx) {
                            if (resx != ' ') {
                                callback('oK');
                                return;
                            }
                            else {
                                callback('oK');
                                return;
                            }
                        });

                    }
                }


                //var ar_data_text = JSON.parse(data_json[0]['data_text']);
                //var ar_data_response_from_cane = JSON.parse(data_json[0]['response_from_cane']);
                //console.log(data_json);
            }
        });
    }
}

/*
setTimeout(function ()
{

}, 1000);
*/
exports.resend_cut2crush = resend_cut2crush;