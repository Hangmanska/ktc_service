
//#region modules

var utl = require('Utility.js');
var utcp = require('Utility_tcp.js');
var iSrv = require('iReport.js');

var inout = require('inout_polygon.js');
var ktc2cane = require('ktc2cane.js');

var dblink = 'dbname=dbu_101279 port=5432';
var status_name = "out_of_service";

var db = require('iConnectdb_ktc.js');
var iconn = require('conn_sugar_cane.js');
var pg_htt = new db.im2(iconn.get_dbconfig_htt());
var pg_realtime = new db.im2(iconn.get_dbconfig_realtime());

var result = { 'blackbox_id': '', 'plot_code': '', 'r_time': '', 'htt_id_lost': '','name':' ','r_distance':' ' }


//#endregion

    //(รถตัด (สายพานลำเลียงหมุน + อยู่ในไร่)) + (รถบรรทุก อยู่ภายใน 15 เมตร)
    //101.99815 16.520133

function has_harvester_truck(backbox_id_havester, lon, lat, meter_radius, callback)
{
    //lon = "102.07184"
    //lat = "16.4056";
    var sql = "  SELECT blackbox_id,r_lon,r_lat,idate(r_time)as r_time,htt_id_lost,r_distance,get_truck_number(blackbox_id) as truck_name ";
    sql += "  FROM rec_now ";
    sql += "  WHERE  ST_DWithin( ";
    sql += "  ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 )::geography "; //AS havester 
    sql += " ,ST_SetSRID( ST_Point(r_lon,r_lat), 4326 )::geography ";// AS truck 
    sql += " , " + meter_radius + ")  "
    sql += " AND htt_harvester_or_truck ='1' AND htt_status_operation !='LOADING'   LIMIT 1 ";  //htt_havester ='1' this mean truck
   // sql += " LIMIT 1 ";
   // var st1 = false; var st2 = false;


   debugger;
    db.get_rows(pg_realtime, sql, function (res) {
    
        // console.log(res);
       if (res.length > 0)
       {
            result.blackbox_id = res[0]['blackbox_id'];
            result.r_time = res[0]['r_time'];
            result.htt_id_lost = res[0]['htt_id_lost'];
            result.r_distance = res[0]['r_distance'];
            result.name = res[0]['truck_name'];

            /*
            ktc2cane.get_truck_code(result.blackbox_id, function (truck_name) {
                debugger;

                if (truck_name.length > 0) {
                    result.name = truck_name;
                    callback(result);
                    return;
                } else {
                    console.log('not found truck_code');
                    callback(result);
                    return;
                }
            });
            */
            callback(result);
            return;

        } else {
            result.blackbox_id = 0;
            callback(result);
            return;
        }

    });

    //#region
    /*
    is_havester_infarm(backbox_id_havester, lon, lat, function (resx) {
        //   if (resx != 0) {
        debugger;
        result.plot_code = resx;
        st2 = true;
        fin();
        //  } 
    });

    function fin()
    {
        if (st1 && st2)
        {
            //if (result.blackbox_id != 0 && result.plot_code != 0)
            //{
                callback(result);
                return;
           // }
        }
    }
*/
    //#endregion

}

function has_truck_havester(backbox_id_truck, lon, lat, meter_radius, callback)
{

    var sql = "  SELECT blackbox_id,r_lon,r_lat,idate(r_time)as r_time,htt_id_lost ";
    sql += "  FROM rec_now ";
    sql += "  WHERE  ST_DWithin( ";
    sql += "  ST_SetSRID( ST_Point(" + lon + "," + lat + "), 4326 )::geography "; //AS havester 
    sql += " ,ST_SetSRID( ST_Point(r_lon,r_lat), 4326 )::geography ";// AS truck 
    sql += " , " + meter_radius + ")  "
    sql += " AND htt_harvester_or_truck ='0' LIMIT 1 ";  //htt_havester ='0' this mean havester
    // sql += " LIMIT 1 ";
    // var st1 = false; var st2 = false;



    db.get_rows(pg_realtime, sql, function (res) {
        // debugger;
        // console.log(res);
        if (res.length > 0)
        {
            result.blackbox_id = res[0]['blackbox_id'];
            result.r_time = res[0]['r_time'];
            result.htt_id_lost = res[0]['htt_id_lost'];
            //get_truck_code(result.blackbox_id, function (truck_name)
            //{
            //    debugger;
            //    if (truck_name.length > 0)
            //    {
            //        callback(result);
            //        return;
            //    }
            //});
            callback(result);
            return;

        } else {
            result.blackbox_id = 0;
            callback(result);
            return;
        }

    });


}

function is_infarm(blackbox_id, lon, lat, callback)
{
    //lon = 102.195250325693;
    //lat = 16.4149841094033;
    inout.is_inconfig_polygon(blackbox_id, lon, lat, function (res) {
        callback(res);
        return;
    })

}


function is_infarm_buffer(blackbox_id, lon, lat,meter_radius, callback)
{
    //lon = 102.195250325693;
    //lat = 16.4149841094033;
    inout.is_inconfig_polygon_buffer(blackbox_id, lon, lat, meter_radius, function (res) {
        callback(res);
        return;
    })

}



//189600101733


exports.has_truck_havester = has_truck_havester
exports.has_harvester_truck = has_harvester_truck;
exports.is_infarm = is_infarm;
exports.is_infarm_buffer = is_infarm_buffer;



    //#region test
    /*   
    setTimeout(function ()
    {
        //lon = 102.195250325693;//lat=16.4149841094033;  // latlon in farm with this blackbox
       // 101.99815, 16.520133  lat lon not in
       //  start_out_of_service('K003746', 'รถตัด', '2015-10-07 07:05:00','4');
       //  is_infarm(102.195250325693,16.4149841094033);
        //has_harvester_truck('104090169333', '100.63874', '13.667367', 15, function (result)
        //{
        //    debugger;
        //    console.log(result);
        //});
        debugger;
        var lon = 101.97563; //101.975655;
        var lat = 16.575752;// 16.575855;
        is_infarm_buffer('189600118135', lon, lat, function (res) {
            debugger;
            console.log(res);
        });

       
    }, 1000)
*/
    //#endregion